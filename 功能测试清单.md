# ESP32S3+MaixCAM智能家居系统 - 完整功能测试清单

## 📋 项目概述

这是一个基于ESP32S3和MaixCAM双主控的智能家居系统，集成了传感器监测、设备控制、AI视觉检测和Web远程控制等功能。

## 🔌 硬件接线指南

### ESP32S3主控板接线

#### 传感器接线
| 传感器 | 型号 | ESP32引脚 | 接线说明 |
|--------|------|-----------|----------|
| 温湿度传感器 | DHT11 | GPIO4 | VCC→3.3V, GND→GND, DATA→GPIO4 |
| 烟雾传感器 | MQ-2 | GPIO5(TTL), GPIO6(ADC) | VCC→5V, GND→GND, DO→GPIO5, AO→GPIO6 |
| 光敏电阻 | 5516 | GPIO8(DO), GPIO7(AO) | VCC→3.3V, GND→GND, DO→GPIO8, AO→GPIO7 |
| CO2传感器 | JW01 | GPIO9(RX), GPIO10(TX) | VCC→5V, GND→GND, TX→GPIO9, RX→GPIO10 |

#### 执行器接线
| 设备 | 型号 | ESP32引脚 | 接线说明 |
|------|------|-----------|----------|
| 直流电机 | TB6612驱动 | GPIO14(IN1), GPIO15(IN2), GPIO16(PWM) | 详见下方TB6612接线图 |
| 舵机 | MG90S | GPIO38 | 红线→5V, 棕线→GND, 橙线→GPIO38 |
| RGB指示灯 | 外接LED | GPIO11(R), GPIO12(G), GPIO13(B) | 共阴极接法，限流电阻220Ω |

#### TB6612电机驱动模块详细接线

**TB6612模块引脚说明：**
```
TB6612FNG模块引脚布局（从上往下看）：
┌─────────────────────┐
│ PWMA  AIN2  AIN1   │  ← 电机A控制端
│ GND①  GND②  VCC    │  ← 电源端（注意有2个GND）
│ VM    A01   A02    │  ← 电机A输出端
│ STBY  BIN1  BIN2   │  ← 待机和电机B控制端  
│ GND③  B02   B01    │  ← 电机B输出端
│ GND④  PWMB  VCC    │  ← 电机B控制和电源端
└─────────────────────┘

注意：GND①②③④在模块内部是连通的，可以接任意一个
```

**ESP32S3 ↔ TB6612 ↔ 直流电机接线表：**

| ESP32S3引脚 | TB6612引脚 | 功能说明 | 备注 |
|-------------|------------|----------|------|
| GPIO14 | AIN1 | 电机方向控制1 | 数字信号 |
| GPIO15 | AIN2 | 电机方向控制2 | 数字信号 |
| GPIO16 | PWMA | 电机速度控制(PWM) | PWM信号 |
| 3.3V | VCC | 逻辑电源(3.3V) | 任意一个VCC |
| **ESP32 GND** | **GND①或GND②** | **逻辑地线** | **选择上排任意GND** |
| **3.3V** | **STBY** | **待机控制(高电平使能)** | **⚠️ 关键：必须连接！** |
| 5V外接电源+ | VM | 电机电源(5-12V) | 大电流电源 |
| **5V外接电源-** | **GND③或GND④** | **电机电源地线** | **选择下排任意GND** |

**电机连接：**
| 直流电机 | TB6612引脚 | 说明 |
|----------|------------|------|
| **电机红线(+)** | **A01** | 电机正极 |
| **电机黑线(-)** | **A02** | 电机负极 |

**接线步骤（推荐顺序）：**

1. **⚠️ 断电操作**：确保所有设备都已断电

2. **逻辑电源连接**：
   - TB6612的VCC(任意一个) → ESP32S3的3.3V
   - TB6612的GND①或GND② → ESP32S3的GND
   - **⚠️ 关键**：TB6612的STBY → ESP32S3的3.3V（使能驱动器）

3. **控制信号连接**：
   - TB6612的AIN1 → ESP32S3的GPIO14
   - TB6612的AIN2 → ESP32S3的GPIO15  
   - TB6612的PWMA → ESP32S3的GPIO16

4. **电机电源连接**：
   - 外接5V电源正极 → TB6612的VM
   - 外接5V电源负极 → TB6612的GND③或GND④
   - **重要**：外接5V电源负极也要连接到ESP32的GND（共地）

5. **电机连接**：
   - 直流电机红线 → TB6612的A01
   - 直流电机黑线 → TB6612的A02

**简化记忆方法：**
- **上排GND** → 连ESP32（逻辑地）
- **下排GND** → 连外接电源（电机地）
- **所有GND最终都要连通**（共地原则）

**电机控制逻辑：**
| AIN1 | AIN2 | PWMA | 电机状态 |
|------|------|------|----------|
| 0 | 0 | X | 停止(刹车) |
| 0 | 1 | PWM | 反转 |
| 1 | 0 | PWM | 正转 |
| 1 | 1 | X | 停止(刹车) |

#### 电源要求
- **ESP32S3**: 5V/2A USB供电
- **传感器**: 3.3V/5V（根据传感器规格）
- **TB6612电机驱动**: 
  - 逻辑电源: 3.3V（来自ESP32）
  - 电机电源: 5V/1A独立供电（推荐使用外接电源适配器）
  - 注意: VM和VCC是分离的，VM需要更大电流
- **舵机**: 5V/500mA

### 重要安全提示
⚠️ **电源分离**: TB6612的VM(电机电源)和VCC(逻辑电源)必须分离供电
⚠️ **共地连接**: 所有设备的GND必须连接在一起
⚠️ **电流容量**: 电机电源需要足够的电流容量(建议1A以上)
⚠️ **接线检查**: 上电前务必检查所有连线，避免短路

### MaixCAM主控板
- **供电**: USB-C 5V/1A
- **WiFi**: 连接到与ESP32相同的局域网
- **摄像头**: 内置，无需外接
- **显示屏**: 内置LCD，用于本地显示

---

## 🧪 功能测试步骤

### 阶段1: 硬件连接测试

#### 1.1 ESP32S3基础测试
- [ ] **供电测试**: ESP32S3上电，板载LED亮起
- [ ] **串口测试**: 连接USB，波特率115200，能看到启动日志
- [ ] **WiFi连接**: 检查连接到指定WiFi网络（SSID: 8505）

#### 1.2 传感器连接测试
- [ ] **DHT11温湿度**: 
  - 接线: VCC→3.3V, GND→GND, DATA→GPIO4
  - 测试: 串口输出温度和湿度数值
  - 预期: 温度15-35°C，湿度30-80%
  
- [ ] **MQ-2烟雾传感器**:
  - 接线: VCC→5V, GND→GND, DO→GPIO5, AO→GPIO6
  - 测试: 用打火机测试（保持安全距离）
  - 预期: 检测到烟雾时DO输出高电平，AO电压升高

- [ ] **5516光敏电阻**:
  - 接线: VCC→3.3V, GND→GND, DO→GPIO8, AO→GPIO7
  - 测试: 用手遮挡光线
  - 预期: 光线变化时DO状态改变，AO电压变化

- [ ] **JW01 CO2传感器**:
  - 接线: VCC→5V, GND→GND, TX→GPIO9, RX→GPIO10
  - 测试: 对着传感器呼气
  - 预期: CO2浓度数值升高（正常400-1000ppm）

#### 1.3 执行器连接测试
- [ ] **TB6612电机驱动**:
  - **ESP32连接**: AIN1→GPIO15, AIN2→GPIO16, PWMA→GPIO17
  - **电源连接**: VCC→3.3V, VM→5V外接电源, GND→共地, STBY→3.3V
  - **电机连接**: A01→电机红线, A02→电机黑线
  - **测试**: 发送MOTOR_50命令
  - **预期**: 电机正转，速度约50%
  - **检查**: 确认电机转向和速度控制正常

- [ ] **MG90S舵机**:
  - 接线: 红线→5V, 棕线→GND, 橙线→GPIO38
  - 测试: 发送SERVO_90命令
  - 预期: 舵机转到90度位置

- [ ] **RGB指示灯**:
  - 接线: R/G/B分别连接GPIO11/12/13，共阴极
  - 测试: 系统启动后应显示绿色
  - 预期: 正常时绿色，警报时红色

### 阶段2: MaixCAM视觉系统测试

#### 2.1 MaixCAM基础测试
- [ ] **系统启动**: 
  - 上电后LCD显示启动画面
  - SSH连接: `ssh root@192.168.31.43`
  - 检查IP地址是否正确

- [ ] **摄像头测试**:
  - 运行: `python3 /root/main.py`
  - 预期: 本地LCD显示摄像头画面
  - 检查画面清晰度和帧率

- [ ] **手势识别模式启动**:
  - 运行: `python3 /root/main_gesture.py`
  - 预期: 启动手势识别增强版
  - 检查: 控制台显示"手部关键点模型加载成功"

#### 2.2 AI检测功能测试
- [ ] **人员检测**:
  - 测试: 人员在摄像头前移动
  - 预期: 画面中出现蓝色检测框，标注"human"
  - 检查: 置信度>50%

- [ ] **火焰检测**:
  - 测试: 用打火机在摄像头前（安全距离）
  - 预期: 画面中出现红色检测框，标注"fire"
  - 检查: 置信度>50%

- [ ] **手势识别检测**:
  - 测试: 在摄像头前做各种手势
  - 预期: 画面显示手部关键点和手势标签
  - 检查: 手势识别准确率>80%

#### 2.3 手势识别专项测试

**🤚 支持的手势类型**
| 手势 | 描述 | 控制功能 | 测试方法 |
|------|------|----------|----------|
| 👆 单指指向上 | 只有食指伸展 | LED灯开 | 食指向上，其他手指握拳 |
| ✌️ 比V手势 | 食指和中指伸展 | 风扇开 | 做胜利手势，保持2秒 |
| 👋 五指张开 | 所有手指都伸展 | 全部关闭 | 手掌完全张开 |
| 👍 竖大拇指 | 只有拇指伸展 | 窗帘开 | 竖起大拇指，其他手指握拳 |
| ✊ 握拳 | 所有手指都不伸展 | 安防模式 | 紧握拳头 |
| 🤟 摇滚手势 | 拇指、食指、小指伸展 | 特殊模式 | 做摇滚手势 |

**🧪 手势识别测试步骤**

1. **基础手势测试**
   ```bash
   测试环境：
   - [ ] 光线充足（避免阴影）
   - [ ] 手部距离摄像头30-60cm
   - [ ] 手掌正对摄像头
   - [ ] 背景简洁，避免干扰
   ```

2. **单个手势准确性测试**
   ```bash
   对每个手势进行10次测试：
   - [ ] 👆 单指指向上：识别率 ≥ 8/10
   - [ ] ✌️ 比V手势：识别率 ≥ 8/10  
   - [ ] 👋 五指张开：识别率 ≥ 9/10
   - [ ] 👍 竖大拇指：识别率 ≥ 8/10
   - [ ] ✊ 握拳：识别率 ≥ 9/10
   - [ ] 🤟 摇滚手势：识别率 ≥ 7/10
   ```

3. **手势稳定性测试**
   ```bash
   测试手势稳定检测机制：
   - [ ] 快速变换手势：不应误触发
   - [ ] 保持手势3秒：应稳定识别
   - [ ] 手势置信度：应显示>0.8
   - [ ] 连续相同手势：只发送一次控制命令
   ```

4. **手势控制响应测试**
   ```bash
   验证手势到设备控制的完整链路：
   - [ ] 👆 → LED灯开：检查实际LED状态
   - [ ] ✌️ → 风扇开：检查电机是否启动
   - [ ] 👋 → 全部关闭：检查所有设备关闭
   - [ ] 👍 → 窗帘开：检查舵机是否转动
   - [ ] ✊ → 安防模式：检查系统进入安防状态
   ```

5. **边界条件测试**
   ```bash
   测试各种边界情况：
   - [ ] 手部部分遮挡：识别是否正常
   - [ ] 不同角度：侧面、倾斜角度
   - [ ] 不同距离：20cm, 40cm, 80cm
   - [ ] 不同光照：明亮、昏暗、逆光
   - [ ] 多手干扰：两只手同时出现
   ```

**🔧 手势识别故障排查**

**问题1：手势无法识别**
```bash
检查步骤：
1. 确认手部关键点模型加载成功
   - 查看启动日志："手部关键点模型加载成功"
   - 如果失败，检查模型文件路径

2. 检查手部检测框
   - 画面中应显示手部边框和21个关键点
   - 如果没有，调整手部位置和光线

3. 验证置信度阈值
   - 当前阈值：0.7（GESTURE_CONFIDENCE_TH）
   - 可临时降低到0.5进行测试
```

**问题2：手势识别不准确**
```bash
优化方法：
1. 改善测试环境
   - 增加光照强度
   - 使用纯色背景
   - 保持手部稳定

2. 调整手势动作
   - 手指伸展更充分
   - 保持手势时间更长（>2秒）
   - 手掌正对摄像头

3. 检查算法参数
   - 手指伸展判断阈值：10像素
   - 手势稳定帧数：3帧
   - 可在代码中调整这些参数
```

**问题3：手势控制无响应**
```bash
诊断流程：
1. 检查WebSocket连接
   - 确认MaixCAM与Web服务器连接正常
   - 查看控制台是否有"手势识别"日志

2. 验证消息格式
   - 手势消息类型："gesture_control"
   - 包含gesture、confidence、action字段

3. 检查设备控制链路
   - Web服务器是否接收到手势消息
   - ESP32是否收到对应的设备控制命令
```

**📊 手势识别性能指标**
| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| 识别准确率 | >80% | 每个手势测试10次 |
| 响应延迟 | <500ms | 从手势到设备动作 |
| 稳定性 | 无误触发 | 快速变换手势测试 |
| 置信度 | >0.8 | 观察显示的置信度数值 |
| 检测距离 | 30-80cm | 不同距离测试 |

#### 2.2 AI检测功能测试
- [ ] **人员检测**:
  - 测试: 人员在摄像头前移动
  - 预期: 画面中出现蓝色检测框，标注"human"
  - 检查: 置信度>50%

- [ ] **火焰检测**:
  - 测试: 用打火机在摄像头前（安全距离）
  - 预期: 画面中出现红色检测框，标注"fire"
  - 检查: 置信度>50%

- [ ] **手势识别检测**:
  - 测试: 在摄像头前做各种手势
  - 预期: 画面显示手部关键点和手势标签
  - 检查: 手势识别准确率>80%

#### 2.4 网络传输测试
- [ ] **MJPEG视频流**:
  - 访问: `http://192.168.31.43:8000`
  - 预期: 浏览器显示实时视频流
  - 检查: 帧率10-20 FPS

- [ ] **WebSocket数据传输**:
  - 检查: MaixCAM终端显示"发送检测结果"
  - 预期: 每100ms发送一次JSON数据
  - 格式: `{"type":"ai_detection","data":{"detections":[...]}}`

- [ ] **手势控制消息传输**:
  - 检查: MaixCAM终端显示"手势识别"日志
  - 预期: 识别到稳定手势时发送控制消息
  - 格式: `{"type":"gesture_control","data":{"gesture":"victory","confidence":0.9,"action":{...}}}`

### 阶段3: Web服务器测试

#### 3.1 服务器启动测试
- [ ] **Node.js服务器**:
  - 进入目录: `cd web`
  - 安装依赖: `npm install`
  - 启动服务: `node server/server.js`
  - 预期: 显示"统一服务器启动成功"，端口8080

#### 3.2 Web界面测试
- [ ] **访问测试**:
  - 浏览器访问: `http://localhost:3000`
  - 预期: 显示"小月智能家居系统"界面
  - 检查: 四个模式按钮正常显示

- [ ] **WebSocket连接**:
  - 点击任意模式的"连接"按钮
  - 服务器: localhost，端口: 8080
  - 预期: 状态显示"已连接"

### 阶段4: 四种模式功能测试

#### 4.1 AI对话模式测试
- [ ] **基础对话**:
  - 输入: "你好"
  - 预期: AI回复问候语
  - 检查: 对话记录正常显示

- [ ] **设备控制对话**:
  - 输入: "开启风扇"
  - 预期: AI执行命令并回复确认
  - 检查: 实际设备响应

- [ ] **状态查询**:
  - 点击"查询状态"按钮
  - 预期: 显示当前传感器数据和设备状态

#### 4.2 传感器监控模式测试
- [ ] **实时数据显示**:
  - 切换到传感器监控模式
  - 预期: 显示温度、湿度、烟雾、光照、CO2数据
  - 检查: 数据每2秒更新一次

- [ ] **数据图表**:
  - 观察数据变化趋势图
  - 预期: 图表实时更新，显示历史数据
  - 检查: 图表样式和数据准确性

- [ ] **阈值警报**:
  - 人为改变环境条件（如用热风吹DHT11）
  - 预期: 超过阈值时显示警报状态
  - 检查: 警报颜色和提示信息

#### 4.3 设备控制模式测试
- [ ] **风扇控制**:
  - 点击"开启"按钮
  - 调节速度滑块到不同位置
  - 预期: 电机转速随滑块变化
  - 测试: 低速30%、中速50%、全速100%

- [ ] **窗户控制**:
  - 点击"开启"按钮
  - 调节角度滑块到不同位置
  - 预期: 舵机角度随滑块变化
  - 测试: 小开45°、半开90°、全开180°

- [ ] **指示灯控制**:
  - 默认应该显示绿色（正常状态）
  - 人为触发警报条件
  - 预期: 指示灯变为红色
  - 检查: 颜色变化和状态文字

- [ ] **自动安防模式**:
  - 开启自动安防开关
  - 触发各种条件（高温、高湿度、烟雾）
  - 预期: 系统自动执行对应动作
  - 检查: 动作日志和实际设备响应

#### 4.4 视觉检测模式测试
- [ ] **视频流显示**:
  - 切换到视觉检测模式
  - 预期: 显示MaixCAM实时视频流
  - 检查: 画面清晰，延迟<500ms

- [ ] **检测结果显示**:
  - 人员在摄像头前移动
  - 预期: 右侧面板显示检测到的人数
  - 检查: 数字实时更新，检测日志记录

- [ ] **火焰检测警报**:
  - 用打火机测试（安全距离）
  - 预期: 火焰计数增加，日志显示警报
  - 检查: 如开启自动安防，应触发安全模式

- [ ] **手势控制测试**:
  - 在摄像头前做各种手势
  - 预期: 实时显示手势识别结果
  - 检查: 手势控制命令正确执行

- [ ] **隐私模式**:
  - 开启隐私模式开关
  - 预期: 视频画面模糊，但AI数据正常
  - 检查: 模糊效果和数据传输

#### 4.5 手势控制集成测试
- [ ] **手势→设备联动测试**:
  - 👆 单指指向上 → LED灯开启
  - ✌️ 比V手势 → 风扇启动
  - 👋 五指张开 → 所有设备关闭
  - 👍 竖大拇指 → 窗帘/舵机转动
  - ✊ 握拳 → 系统进入安防模式

- [ ] **手势控制响应时间**:
  - 测试: 从做手势到设备响应的时间
  - 预期: 响应时间<1秒
  - 检查: 手势稳定性（避免误触发）

- [ ] **手势控制日志**:
  - 检查: Web界面显示手势控制日志
  - 预期: 记录手势类型、置信度、执行动作
  - 格式: "手势控制: victory (置信度: 0.92) → 风扇开启"

### 阶段5: 综合集成测试

#### 5.1 多设备协同测试
- [ ] **传感器+设备联动**:
  - 场景: 温度升高→自动开风扇
  - 操作: 用热风吹DHT11传感器
  - 预期: 温度>28°C时风扇自动启动
  - 检查: 响应时间<5秒

- [ ] **视觉+设备联动**:
  - 场景: AI检测到火焰→关闭窗户
  - 操作: 在摄像头前用打火机
  - 预期: 检测到火焰后窗户自动关闭
  - 检查: 联动动作和日志记录

- [ ] **手势+设备联动**:
  - 场景: 手势控制→设备响应
  - 操作: 做👆手势→LED灯开启
  - 预期: 手势识别后设备立即响应
  - 检查: 完整控制链路正常

- [ ] **多模式混合控制**:
  - 场景: 同时使用传感器、AI检测、手势控制
  - 操作: 传感器触发+手势控制+AI检测
  - 预期: 各种控制方式互不干扰
  - 检查: 优先级处理正确

#### 5.2 网络稳定性测试
- [ ] **长时间运行**:
  - 连续运行30分钟
  - 检查: 无连接断开，数据传输正常
  - 监控: 内存使用和CPU占用

- [ ] **网络波动测试**:
  - 暂时断开WiFi连接
  - 恢复网络连接
  - 预期: 系统自动重连，功能恢复

#### 5.3 性能压力测试
- [ ] **高频操作测试**:
  - 快速切换设备开关状态
  - 快速调节滑块数值
  - 预期: 系统响应正常，无卡顿

- [ ] **多用户访问**:
  - 多个浏览器同时访问Web界面
  - 预期: 所有用户都能正常控制和查看

---

## 🔧 故障排查指南

### 网页对话HTTP 500错误排查

#### 🎯 问题根源确认：架构理解错误

**真实架构**：
- ✅ **MaixCAM**：WebSocket客户端，连接到`192.168.31.150:8080`
- ✅ **Web服务器**：WebSocket服务器，监听`8080`端口
- ❌ **错误假设**：Web服务器尝试代理MaixCAM的`8000`端口（实际不存在）

#### ✅ **问题已完全解决：切换到智谱AI免费模型**

**问题根源**：
- 原使用的`glm-4-plus`模型需要付费
- HTTP状态码：429，错误信息："余额不足或无可用资源包,请充值。"

**解决方案**：
- 已将AI模型从`glm-4-plus`切换为`glm-4-flash`（免费模型）
- 修改文件：`web/server/lib/AIService.js`
- 修改文件：`web/test_ai_api.js`

**测试结果**：
```
✅ AI API测试成功!
📝 AI回复: 你好👋！有什么可以帮助你的吗？
```

**验证步骤**：
1. 重启Web服务器：`cd web && npm start`
2. 访问网页：`http://192.168.31.150:8080`
3. 测试AI对话功能，现在应该正常工作了！

**免费模型说明**：
- `glm-4-flash`是智谱AI提供的免费模型
- 提供一定的免费调用额度
- 响应速度快，适合智能家居对话场景

**MaixCAM程序分析**：
```python
WEB_SERVER_IP = "192.168.31.150"  # 连接到你的电脑
WEB_SERVER_PORT = 8080            # Web Server的WebSocket端口
```
MaixCAM是**客户端**，不提供8000端口服务！

#### 🔧 正确的解决方案

**方案1：启动MaixCAM程序（推荐）**
```bash
# 在MaixCAM中执行
cd /tmp/maixpy_run
python3 main.py
```

#### 🔧 MaixCAM程序崩溃解决方案

**常见崩溃原因**：
- `SIGSEGV(11)`: 段错误，通常是内存访问问题
- `No buffer space available`: 摄像头缓冲区不足
- 多个程序同时访问摄像头资源

**解决步骤**：

1. **重启MaixCAM设备**：
```bash
# 在MaixCAM中执行
reboot
```

2. **检查系统资源**：
```bash
# 重新连接后检查
ssh root@192.168.31.43
free -m                    # 检查内存
ps aux | grep python       # 检查进程
```

3. **尝试预装应用**：
```bash
# 使用预装的稳定应用
cd /maixapp/apps/detector_243027
python3 main.py
```

4. **如果仍然崩溃，尝试简化版本**：
```bash
# 运行基础检测应用
cd /maixapp/apps/
ls                         # 查看可用应用
```

**第二步：检查各服务的运行状态**
```bash
# 1. 测试MaixCAM的MJPEG视频流服务
curl -I http://192.168.31.43:8000
# 预期：返回HTTP 200和视频流头信息

# 2. 检查Web服务器8080端口
netstat -an | findstr :8080
# 预期：显示LISTENING状态

# 3. 启动Web服务器（如果未运行）
cd web
node server/server.js
# 预期：显示"统一服务器启动成功"

# 4. 测试Web服务器API
curl http://192.168.31.150:8080
# 预期：返回HTML页面内容
```

**第三步：测试AI对话API**
```bash
# 测试AI对话接口
curl -X POST http://192.168.31.150:8080/api/chat \
  -H "Content-Type: application/json" \
  -d "{\"message\":\"你好\",\"sessionId\":\"test\",\"stream\":false}"

# 如果返回500错误，查看详细错误信息
curl -v -X POST http://192.168.31.150:8080/api/chat \
  -H "Content-Type: application/json" \
  -d "{\"message\":\"你好\",\"sessionId\":\"test\",\"stream\":false}"
```

**第四步：检查智谱AI API连接**
```bash
# 测试智谱AI API是否可达
curl -X POST https://open.bigmodel.cn/api/paas/v4/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer 493d8b1ceaa044168412775f8a4dd707.bebu6cSgM4R7o7wj" \
  -d "{\"model\":\"glm-4-plus\",\"messages\":[{\"role\":\"user\",\"content\":\"你好\"}]}"
```

#### ⚡ 立即解决方案

**方案1：启动MaixCAM服务**
```bash
# SSH连接到MaixCAM
ssh root@192.168.31.43

# 启动主程序
cd /root
python3 main.py
```

**方案2：检查MaixCAM程序状态**
```bash
# 在MaixCAM上检查
ps aux | grep python
ls -la /root/main.py

# 如果文件不存在，检查其他位置
find / -name "main.py" 2>/dev/null
```

**方案3：临时禁用视频流代理**
如果MaixCAM服务无法启动，可以临时注释掉视频流代理：
编辑 `web/server/lib/UnifiedServer.js`，注释第200-280行的MJPEG代理代码

**方案4：重启MaixCAM设备**
```bash
# 在MaixCAM上执行重启
reboot

# 或者物理断电重启
```

#### 🔧 IP地址配置修复

**当前网络配置**：
- 电脑IP：`192.168.31.150` ✅
- 网关：`192.168.31.1` ✅  
- 子网：`192.168.31.0/24` ✅

**需要检查的设备IP**：
1. **ESP32S3**：应该自动获取`192.168.31.xxx`
2. **MaixCAM**：代码中配置为`192.168.31.43`（需要验证）
3. **Web服务器**：运行在`192.168.31.150:8080`

**IP地址修复步骤**：

1. **确认MaixCAM的实际IP**：
   ```bash
   # 扫描整个网段
   for /L %i in (1,1,254) do @ping -n 1 -w 100 192.168.31.%i | findstr "TTL"
   ```

2. **修改代码中的IP配置**：
   - 文件：`web/server/lib/UnifiedServer.js`
   - 位置：第201行
   - 修改：`const MAIXCAM_IP = '实际的MaixCAM_IP';`

3. **验证ESP32的WebSocket连接**：
   - ESP32配置：`ws://192.168.31.150:8080` ✅ **正确**
   - 确保Web服务器在8080端口正常运行

**网络诊断命令**：
```bash
# 检查端口占用
netstat -an | findstr :8080

# 测试Web服务器
curl http://192.168.31.150:8080

# 测试MaixCAM连接
telnet 192.168.31.43 8000
```

#### 📋 测试验证

**验证服务器正常运行**：
1. 访问 `http://localhost:8080` - 应显示Web界面
2. 访问 `http://localhost:8080/api/protocol/docs` - 应返回协议文档
3. WebSocket连接测试 - 在Web界面点击"连接"按钮

**验证AI对话功能**：
1. 在Web界面的AI对话模式输入"你好"
2. 检查是否返回正常回复
3. 查看浏览器开发者工具的Network标签页，确认API请求状态

### 电机故障专项排查步骤

#### 🚨 电机完全不转 - 系统性排查

**⚠️ 最可能的原因：STBY引脚未配置！**

TB6612驱动器有一个STBY（待机）引脚，必须为高电平（3.3V）才能工作。根据代码分析，**当前代码没有配置STBY引脚**，这很可能是电机不转的主要原因。

**🔧 立即解决方案：**
1. **硬件临时修复**：用跳线将TB6612的STBY引脚直接连接到ESP32的3.3V引脚
2. **软件修复**：需要修改代码添加STBY引脚配置（见下方代码修复方案）

**第一步：供电检查**
- [ ] **ESP32S3供电**: 确认USB连接正常，板载LED亮起
- [ ] **TB6612逻辑电源**: 用万用表测量TB6612的VCC引脚，应为3.3V
- [ ] **TB6612电机电源**: 用万用表测量TB6612的VM引脚，应为5V
- [ ] **外接电源**: 确认5V电源适配器输出正常，电流容量≥1A
- [ ] **共地连接**: 确认ESP32 GND、TB6612 GND、外接电源GND都已连通

**第二步：接线检查**
```
关键接线核对清单：
┌─────────────────────────────────────────┐
│ ESP32S3    →    TB6612    →    说明     │
├─────────────────────────────────────────┤
│ GPIO14     →    AIN1      →    方向控制1 │
│ GPIO15     →    AIN2      →    方向控制2 │
│ GPIO16     →    PWMA      →    速度控制  │
│ 3.3V       →    VCC       →    逻辑电源  │
│ GND        →    GND①②     →    逻辑地    │
│ 3.3V       →    STBY      →    使能信号  │
├─────────────────────────────────────────┤
│ 5V外接电源+ →    VM        →    电机电源  │
│ 5V外接电源- →    GND③④     →    电机地    │
├─────────────────────────────────────────┤
│ 电机红线    →    A01       →    电机正极  │
│ 电机黑线    →    A02       →    电机负极  │
└─────────────────────────────────────────┘
```

**第三步：信号测试**
- [ ] **STBY信号**: 用万用表测量STBY引脚，应为3.3V（高电平使能）
- [ ] **控制信号**: 启动系统后，用万用表测量AIN1/AIN2引脚电压变化
- [ ] **PWM信号**: 用示波器或万用表测量PWMA引脚是否有PWM输出

**第四步：软件检查**
- [ ] **串口日志**: 检查是否有电机初始化成功的日志
  ```
  预期日志示例：
  I (xxxx) MOTOR_APP: Motor App Init
  I (xxxx) MOTOR_SERVICE: 电机服务初始化完成
  I (xxxx) TB6612_DRIVER: ========== 初始化TB6612电机驱动 ==========
  I (xxxx) TB6612_DRIVER: GPIO配置 - IN1:14, IN2:15, PWM:16
  I (xxxx) SYSTEM: [MOTOR] 电机持续正转任务已启动
  I (xxxx) SYSTEM: [MOTOR] 电机已启动: 正转 80% 速度 (持续运行)
  ```
- [ ] **错误信息**: 查看是否有GPIO或LEDC初始化失败的错误
- [ ] **任务运行**: 确认motor_continuous_task任务正常启动
- [ ] **WebSocket命令测试**: 通过Web界面发送MOTOR_50命令测试

**第五步：硬件测试**
- [ ] **TB6612模块**: 更换TB6612模块测试
- [ ] **电机测试**: 用外接电源直接给电机供电，确认电机本身正常
- [ ] **跳线测试**: 用跳线直接连接TB6612的AIN1/AIN2到3.3V/GND测试

#### 🔍 快速诊断表

| 现象 | 可能原因 | 立即检查 | 解决方案 |
|------|----------|----------|----------|
| **电机无任何反应** | **STBY引脚未连接** | **STBY引脚是否连接到3.3V** | **用跳线连接STBY到3.3V** |
| 电机无任何反应 | 供电问题 | VM引脚是否有5V | 检查外接电源和VM连接 |
| 电机有轻微震动但不转 | 控制信号异常 | AIN1/AIN2是否有电压变化 | 检查GPIO14/15连接 |
| 电机转速很慢 | PWM信号问题 | PWMA引脚是否有PWM输出 | 检查GPIO16连接和LEDC配置 |
| 系统重启或死机 | 电流过大 | 电源电流容量 | 使用≥1A的5V电源 |
| TB6612发热严重 | 短路或过载 | 电机阻抗、接线短路 | 断电检查，更换模块 |
| 串口无电机日志 | 软件初始化失败 | 编译错误、GPIO冲突 | 重新编译烧录 |

```

#### 💻 代码修复方案

**问题根源**：TB6612驱动代码缺少STBY引脚配置

**修复步骤**：

1. **修改TB6612配置结构体** (`components/drivers/tb6612_driver/tb6612_driver.h`)：
```c
typedef struct {
    int gpio_in1;           ///< IN1引脚（方向控制1）
    int gpio_in2;           ///< IN2引脚（方向控制2）
    int gpio_pwm;           ///< PWM引脚（速度控制）
    int gpio_stby;          ///< STBY引脚（待机控制）  // 新增
    uint32_t pwm_freq;      ///< PWM频率（Hz），建议5000-20000
    uint8_t ledc_timer;     ///< LEDC定时器编号（0-3）
    uint8_t ledc_channel;   ///< LEDC通道编号（0-7）
} tb6612_config_t;
```

2. **修改电机应用配置** (`components/application/motor_app/motor_app.c`)：
```c
static const motor_service_config_t s_motor_config = {
    .motor_count = 1,
    .motors = {
        {
            .gpio_in1 = 14,
            .gpio_in2 = 15,
            .gpio_pwm = 16,
            .gpio_stby = 17,        // 新增STBY引脚
            .pwm_freq = 5000,
            .ledc_timer = 2,
            .ledc_channel = 4,
        },
    }
};
```

3. **修改TB6612驱动初始化** (`components/drivers/tb6612_driver/tb6612_driver.c`)：
在`tb6612_create`函数中添加：
```c
// 初始化STBY引脚
ret = init_gpio_output(config->gpio_stby);
if (ret != ESP_OK) {
    ESP_LOGE(TAG, "GPIO STBY初始化失败");
    free(motor);
    return ret;
}

// 使能TB6612（STBY设为高电平）
gpio_set_level(config->gpio_stby, 1);
ESP_LOGI(TAG, "TB6612已使能 (STBY=HIGH)");
```

**临时硬件解决方案**（无需修改代码）：
- 用跳线将TB6612的STBY引脚直接连接到ESP32的3.3V引脚
- 这样TB6612就会一直处于使能状态

#### ⚡ 应急测试方法

**方法1：直接电机测试**
```
1. 断开TB6612连接
2. 用5V电源直接连接电机红黑线
3. 如果电机转动 → TB6612或控制信号问题
4. 如果电机不转 → 电机本身故障
```

**方法2：TB6612手动测试**
```
1. 保持所有连接
2. 用跳线将AIN1连接到3.3V，AIN2连接到GND
3. 用跳线将PWMA连接到3.3V
4. 如果电机转动 → ESP32控制信号问题
5. 如果电机不转 → TB6612模块或供电问题
```

**方法3：万用表电压测试**
```
系统运行时测量关键点电压：
- TB6612 VCC: 应为3.3V
- TB6612 VM: 应为5V  
- TB6612 STBY: 应为3.3V
- TB6612 AIN1: 应在0V-3.3V之间变化
- TB6612 AIN2: 应在0V-3.3V之间变化
- TB6612 PWMA: 应有PWM波形（万用表显示1.5V左右）
```

### 常见问题及解决方案

#### ESP32S3相关问题
| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 无法上电启动 | 供电不足 | 使用5V/2A电源适配器 |
| WiFi连接失败 | SSID/密码错误 | 检查main.c中WiFi配置 |
| 传感器无数据 | 接线错误 | 检查VCC/GND/信号线连接 |
| **电机完全不转** | **供电问题/接线错误** | **详见下方电机故障排查步骤** |
| 电机转向错误 | A01/A02接线反了 | 交换电机红黑线连接 |
| 电机转速异常 | PWM信号问题 | 检查GPIO16连接，确认PWM输出 |
| 舵机不动 | PWM信号异常 | 检查GPIO38连接和5V供电 |

#### MaixCAM相关问题
| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| SSH连接失败 | IP地址错误 | 检查MaixCAM实际IP地址 |
| 摄像头黑屏 | 摄像头模块故障 | 重启MaixCAM或检查硬件 |
| AI检测不准 | 光线不足 | 改善照明条件 |
| 视频流卡顿 | 网络带宽不足 | 降低视频质量或帧率 |

#### Web服务器相关问题
| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 无法访问网页 | 服务器未启动 | 检查Node.js服务器状态 |
| WebSocket连接失败 | 端口被占用 | 检查8080端口占用情况 |
| 数据不更新 | 消息格式错误 | 检查JSON数据格式 |
| 界面显示异常 | 浏览器兼容性 | 使用Chrome或Firefox |

---

## 📊 性能指标参考

### 系统性能指标
| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| 传感器采样频率 | 0.5 Hz (每2秒) | 观察串口日志时间戳 |
| 设备响应时间 | <1秒 | 从发送命令到设备动作 |
| 视频流帧率 | 10-20 FPS | 浏览器开发者工具监控 |
| WebSocket延迟 | <200ms | 时间戳对比 |
| AI检测精度 | >80% | 多次测试统计准确率 |
| 手势识别准确率 | >80% | 每个手势测试10次 |
| 手势控制响应时间 | <500ms | 从手势到设备动作 |

### 资源使用指标
| 资源 | ESP32S3 | MaixCAM | Web服务器 |
|------|---------|---------|-----------|
| 内存使用 | <80% | <70% | <200MB |
| CPU占用 | <60% | <80% | <30% |
| 网络带宽 | <1Mbps | <5Mbps | <10Mbps |

---

## 🎯 验收标准

### 基础功能验收（必须100%通过）
- [ ] 所有传感器数据正常读取
- [ ] 所有执行器设备正常控制
- [ ] Web界面四种模式正常切换
- [ ] WebSocket通信稳定可靠
- [ ] AI视觉检测功能正常
- [ ] 手势识别控制功能正常

### 高级功能验收（建议80%以上通过）
- [ ] 自动安防系统响应及时
- [ ] 多设备联动逻辑正确
- [ ] 长时间运行稳定性良好
- [ ] 网络异常恢复能力强
- [ ] 用户界面体验友好

### 性能验收（建议达到目标值）
- [ ] 系统响应时间满足要求
- [ ] 视频流质量和帧率达标
- [ ] 资源使用在合理范围内
- [ ] AI检测精度满足需求

---

## 📝 测试记录表

### 测试环境信息
- **测试日期**: ___________
- **测试人员**: ___________
- **硬件版本**: ESP32S3 + MaixCAM
- **软件版本**: ___________
- **网络环境**: WiFi SSID: ___________

### 测试结果记录
| 测试项目 | 预期结果 | 实际结果 | 通过/失败 | 备注 |
|----------|----------|----------|-----------|------|
| ESP32S3启动 | 正常启动日志 |  |  |  |
| WiFi连接 | 连接成功 |  |  |  |
| DHT11传感器 | 温湿度数据 |  |  |  |
| MQ-2传感器 | 烟雾检测 |  |  |  |
| 电机控制 | 正反转调速 |  |  |  |
| 舵机控制 | 角度控制 |  |  |  |
| MaixCAM启动 | AI检测正常 |  |  |  |
| 视频流 | 实时画面 |  |  |  |
| 手势识别 | 6种手势识别 |  |  |  |
| 手势控制 | 设备响应正常 |  |  |  |
| Web界面 | 四模式正常 |  |  |  |
| 自动安防 | 联动响应 |  |  |  |

### 问题记录
| 问题描述 | 影响程度 | 解决方案 | 解决状态 |
|----------|----------|----------|----------|
| 网页AI对话HTTP 500错误 | 高 | 切换到智谱AI免费模型glm-4-flash | ✅ 已解决 |
| TB6612电机驱动STBY引脚未配置 | 中 | 硬件跳线连接STBY到3.3V | ✅ 已解决 |
|  |  |  |  |
|  |  |  |  |

---

## 🚀 扩展功能建议

### 短期扩展（1-2周）
1. **语音控制**: 集成语音识别，支持语音命令
2. **移动APP**: 开发手机APP，支持远程控制
3. **数据存储**: 添加数据库，存储历史数据
4. **告警推送**: 异常情况微信/邮件推送

### 中期扩展（1-2月）
1. **更多传感器**: 添加PM2.5、噪音、紫外线传感器
2. **更多设备**: 支持空调、灯光、窗帘控制
3. **场景模式**: 预设回家、离家、睡眠等场景
4. **用户管理**: 多用户权限管理

### 长期扩展（3-6月）
1. **边缘AI**: 本地语音识别和自然语言处理
2. **物联网平台**: 接入阿里云、腾讯云IoT平台
3. **大数据分析**: 用户行为分析和智能推荐
4. **商业化**: 产品化设计和批量生产

---

**测试完成标志**: 当所有基础功能测试通过，高级功能通过率>80%，性能指标达标时，可认为系统测试完成，具备演示和使用条件。
