<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æœˆæ™ºèƒ½å®¶å±…ç³»ç»Ÿ</title>
    <!-- Chart.jsåº“ç”¨äºæ•°æ®å¯è§†åŒ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="css/tech-theme.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>&#127769; å°æœˆæ™ºèƒ½å®¶å±…ç³»ç»Ÿ</h1>
            <div class="mode-switch">
                <button class="btn-switch active" onclick="switchToAIMode()">AIå¯¹è¯</button>
                <button class="btn-switch" onclick="switchToSensorMode()">ä¼ æ„Ÿå™¨ç›‘æ§</button>
                <button class="btn-switch" onclick="switchToControlMode()">æ§åˆ¶æ¨¡å¼</button>
                <button class="btn-switch" onclick="switchToVisionMode()">ğŸ¥ è§†è§‰æ£€æµ‹</button>
            </div>
        </header>

        <main id="mainContent">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </main>
    </div>

    <!-- å¼•å…¥JavaScriptæ–‡ä»¶ -->
    <!-- ç”±äº index.html å†…éƒ¨å·²ç»é›†æˆäº† ModeManagerï¼Œä»¥ä¸‹æ—§ç‰ˆè„šæœ¬ä¼šå¯¼è‡´å†²çªï¼Œæ•…æš‚æ—¶ç¦ç”¨ -->
    <!-- <script src="js/ConnectionManager.js"></script> -->
    <!-- <script src="js/UIManager.js"></script> -->
    <script src="js/TTSClient.js"></script>
    <script src="js/AIManager.js"></script>
    <script src="js/GestureVoiceManager.js"></script>
    <!-- <script src="js/App.js"></script> -->

    <script>
        // æ¨¡å¼ç®¡ç†å™¨
        class ModeManager {
            constructor() {
                this.currentMode = 'ai';
                this.aiManager = null;

                // å…±äº«WebSocketè¿æ¥
                this.sharedWs = null;
                this.wsServer = 'localhost';
                this.wsPort = '8080';
                this.isConnected = false;

                // ä¿å­˜æœ€åæ¥æ”¶çš„ä¼ æ„Ÿå™¨æ•°æ®
                this.lastSensorData = null;

                // ========== è‡ªåŠ¨å®‰é˜²ç³»ç»Ÿ (Auto Safety Mode) ==========
                this.autoSafetyEnabled = false;  // æ€»å¼€å…³

                // è‡ªåŠ¨åŒ–è§„åˆ™é˜ˆå€¼ (æ¯”èµ›æ¼”ç¤ºç”¨ï¼Œé˜ˆå€¼è°ƒä½ä¾¿äºè§¦å‘)
                this.autoRules = {
                    // ğŸ”¥ ç«ç„°æ£€æµ‹ â†’ å®‰å…¨æ¨¡å¼
                    fireDetection: {
                        enabled: true,
                        action: 'å…³é—­çª—æˆ· + çº¢è‰²è­¦æŠ¥'
                    },
                    // ğŸŒ¡ï¸ é«˜æ¸© â†’ å¼€é£æ‰‡
                    highTemperature: {
                        enabled: true,
                        threshold: 28,  // æ¯”èµ›æ¼”ç¤ºç”¨ï¼ˆæ­£å¸¸å¯è®¾30ï¼‰
                        action: 'å¼€å¯é£æ‰‡'
                    },
                    // ğŸ’§ é«˜æ¹¿åº¦(å›å—å¤©) â†’ å…³çª—
                    highHumidity: {
                        enabled: true,
                        threshold: 75,  // æ¯”èµ›æ¼”ç¤ºç”¨
                        action: 'å…³é—­çª—æˆ·é˜²æ½®'
                    },
                    // ğŸ‘¤ äººå‘˜æ£€æµ‹ â†’ å¼€ç¯
                    humanDetection: {
                        enabled: true,
                        action: 'å¼€å¯ç…§æ˜'
                    }
                };

                // é˜²æ­¢é‡å¤è§¦å‘çš„å†·å´æ—¶é—´ (æ¯«ç§’)
                this.ruleCooldowns = {};
                this.cooldownTime = 10000; // 10ç§’å†…ä¸é‡å¤è§¦å‘åŒä¸€è§„åˆ™
            }

            init() {
                // é»˜è®¤åŠ è½½AIæ¨¡å¼
                this.switchToAIMode();
            }

            // å…±äº«è¿æ¥æ–¹æ³•
            connectSharedWebSocket(server, port) {
                if (this.sharedWs && this.sharedWs.readyState === WebSocket.OPEN) {
                    console.log('âœ… å·²è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥');
                    return;
                }

                this.wsServer = server;
                this.wsPort = port;
                const wsUrl = `ws://${server}:${port}`;
                console.log('ğŸ”— å°è¯•è¿æ¥WebSocket:', wsUrl);
                console.log('ğŸ”— æœåŠ¡å™¨:', server);
                console.log('ğŸ”— ç«¯å£:', port);

                try {
                    this.sharedWs = new WebSocket(wsUrl);

                    this.sharedWs.onopen = () => {
                        console.log('âœ…âœ…âœ… WebSocketè¿æ¥æˆåŠŸ! âœ…âœ…âœ…');
                        console.log('âœ… è¿æ¥URL:', wsUrl);
                        console.log('âœ… çŠ¶æ€ç :', this.sharedWs.readyState, '(1=OPEN)');
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                    };
                } catch (error) {
                    console.error('âŒ WebSocketåˆ›å»ºå¤±è´¥:', error);
                }

                this.sharedWs.onmessage = (event) => {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºäºŒè¿›åˆ¶æ¶ˆæ¯ï¼ˆJPEGå›¾åƒå¸§ï¼‰
                    if (event.data instanceof Blob) {
                        console.log('ğŸ“· æ”¶åˆ°å›¾åƒå¸§:', event.data.size, 'å­—èŠ‚');
                        // ä»…åœ¨visionæ¨¡å¼ä¸‹å¤„ç†å›¾åƒå¸§
                        if (this.currentMode === 'vision') {
                            this.handleVisionImageFrame(event.data);
                        }
                        return;
                    }

                    // æ–‡æœ¬æ¶ˆæ¯å¤„ç†
                    console.log('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯:', event.data);
                    try {
                        const message = JSON.parse(event.data);

                        // AIæ£€æµ‹æ•°æ® - å‘é€åˆ°visionæ¨¡å¼
                        if (message.type === 'ai_detection') {
                            // è§†è§‰æ¨¡å¼ä¸‹æ›´æ–°æ˜¾ç¤º
                            if (this.currentMode === 'vision') {
                                this.handleVisionTextMessage(message);
                            }

                            // ğŸ”¥ è‡ªåŠ¨å®‰é˜²: AIç«ç„°æ£€æµ‹
                            if (this.autoSafetyEnabled && this.autoRules.fireDetection.enabled) {
                                const detections = message.data?.detections || [];
                                const fireCount = detections.filter(d => d.class_id !== 0).length; // éäººç±»=ç«ç„°

                                if (fireCount > 0) {
                                    this.triggerAutoAction('aiFireDetection', 'ğŸ”¥ AIè§†è§‰ç«ç„°è­¦æŠ¥',
                                        `æ‘„åƒå¤´æ£€æµ‹åˆ° ${fireCount} å¤„ç«æºï¼Œå¯åŠ¨å®‰å…¨æ¨¡å¼`,
                                        () => {
                                            // å…³é—­çª—æˆ·
                                            if (typeof toggleWindow === 'function') toggleWindow(false);
                                            // å¯ä»¥æ·»åŠ æ›´å¤šå®‰å…¨åŠ¨ä½œ
                                        });
                                }
                            }
                            return;
                        }

                        // æ‰‹åŠ¿æ§åˆ¶æ¶ˆæ¯ - å‘é€åˆ°GestureVoiceManager
                        if (message.type === 'gesture_control') {
                            console.log('âœ‹ æ”¶åˆ°æ‰‹åŠ¿æ§åˆ¶æ¶ˆæ¯:', message);
                            if (window.gestureVoiceManager) {
                                window.gestureVoiceManager.handleGestureMessage(message);
                            }
                            return;
                        }

                        // ä¼ æ„Ÿå™¨æ•°æ®æ¶ˆæ¯ï¼ˆåŒæ—¶æ›´æ–°æ‰€æœ‰é¡µé¢ï¼‰
                        if (message.type === 'message' && message.data && typeof message.data === 'object') {
                            // ä¿å­˜æœ€åçš„æ•°æ®
                            this.lastSensorData = message.data;

                            // æ›´æ–°ä¼ æ„Ÿå™¨ç›‘æ§é¡µé¢
                            this.updateSensorDisplay(message.data);

                            // æ›´æ–°æ§åˆ¶é¡µé¢çš„æ¸©åº¦æ˜¾ç¤º
                            const tempEl = document.getElementById('acCurrentTemp');
                            if (tempEl && message.data.temperature !== undefined) {
                                tempEl.textContent = `${message.data.temperature.toFixed(1)}Â°C`;
                            }
                        }

                        // ç³»ç»Ÿæ¶ˆæ¯ - å‘é€åˆ°visionæ¨¡å¼
                        if (message.type === 'system' && this.currentMode === 'vision') {
                            this.handleVisionTextMessage(message);
                        }
                    } catch (e) {
                        console.error('æ¶ˆæ¯è§£æå¤±è´¥:', e);
                    }
                };

                this.sharedWs.onclose = (event) => {
                    console.log('âš ï¸âš ï¸âš ï¸ WebSocketè¿æ¥å·²å…³é—­ âš ï¸âš ï¸âš ï¸');
                    console.log('âš ï¸ å…³é—­ä»£ç :', event.code);
                    console.log('âš ï¸ å…³é—­åŸå› :', event.reason || 'æ— ');
                    console.log('âš ï¸ æ˜¯å¦æ­£å¸¸å…³é—­:', event.wasClean);
                    this.isConnected = false;
                    this.sharedWs = null;
                    this.updateConnectionStatus(false);
                };

                this.sharedWs.onerror = (error) => {
                    console.error('âŒâŒâŒ WebSocketè¿æ¥é”™è¯¯! âŒâŒâŒ');
                    console.error('âŒ é”™è¯¯å¯¹è±¡:', error);
                    console.error('âŒ è¿æ¥URL:', wsUrl);
                    console.error('âŒ å¯èƒ½åŸå› :');
                    console.error('   1. WebSocketæœåŠ¡å™¨æœªå¯åŠ¨');
                    console.error('   2. æœåŠ¡å™¨åœ°å€æˆ–ç«¯å£é”™è¯¯');
                    console.error('   3. ç½‘ç»œè¿æ¥é—®é¢˜');
                    console.error('   4. é˜²ç«å¢™é˜»æ­¢è¿æ¥');
                    this.isConnected = false;
                    this.updateConnectionStatus(false, true);
                };
            }

            disconnectSharedWebSocket() {
                if (this.sharedWs) {
                    console.log('ğŸ”Œ æ–­å¼€å…±äº«è¿æ¥');
                    this.sharedWs.close();
                    this.sharedWs = null;
                    this.isConnected = false;
                }
            }

            updateConnectionStatus(connected, error = false) {
                // æ›´æ–°æ‰€æœ‰é¡µé¢çš„è¿æ¥çŠ¶æ€æ˜¾ç¤º
                const statusElements = [
                    document.getElementById('controlConnectionStatus'),
                    document.getElementById('sensorStatus')
                ];
                const connectButtons = [
                    document.getElementById('controlConnectBtn'),
                    document.getElementById('sensorConnectBtn')
                ];
                const disconnectButtons = [
                    document.getElementById('controlDisconnectBtn'),
                    document.getElementById('sensorDisconnectBtn')
                ];

                statusElements.forEach(el => {
                    if (el) {
                        if (connected) {
                            el.textContent = 'å·²è¿æ¥';
                            el.className = 'connection-status connected';
                        } else if (error) {
                            el.textContent = 'è¿æ¥å¤±è´¥';
                            el.className = 'connection-status disconnected';
                        } else {
                            el.textContent = 'æœªè¿æ¥';
                            el.className = 'connection-status disconnected';
                        }
                    }
                });

                connectButtons.forEach(btn => {
                    if (btn) btn.disabled = connected;
                });

                disconnectButtons.forEach(btn => {
                    if (btn) btn.disabled = !connected;
                });

                // æ›´æ–° vision æ¨¡å¼çš„çŠ¶æ€
                this.updateVisionStatus(connected);
            }

            sendMessage(data) {
                if (this.sharedWs && this.sharedWs.readyState === WebSocket.OPEN) {
                    const message = {
                        type: "message",
                        timestamp: Date.now(),
                        data: data
                    };
                    const jsonString = JSON.stringify(message);
                    this.sharedWs.send(jsonString);
                    console.log('ğŸ“¤ å‘é€æ¶ˆæ¯:', message);
                    console.log('ğŸ“¤ JSONå­—ç¬¦ä¸²:', jsonString);
                    console.log('ğŸ“¤ WebSocketçŠ¶æ€:', this.sharedWs.readyState, '(OPEN=1)');
                } else {
                    const state = this.sharedWs ? this.sharedWs.readyState : 'null';
                    console.error('âŒ æ— æ³•å‘é€æ¶ˆæ¯ - WebSocketçŠ¶æ€:', state, '(éœ€è¦=1)');
                    console.error('âŒ WebSocketå¯¹è±¡å­˜åœ¨?', !!this.sharedWs);
                }
            }


            switchToAIMode() {
                this.currentMode = 'ai';
                this.updateModeButtons('ai');

                const main = document.getElementById('mainContent');
                main.innerHTML = `
                    <section class="ai-chat-section">
                        <div class="ai-chat-container">
                            <div class="ai-chat-header">
                                <h3>å°æœˆæ™ºèƒ½å¯¹è¯</h3>
                                <p>å¯ä»¥ä¸å°æœˆè¿›è¡Œè‡ªç„¶å¯¹è¯ï¼Œæ§åˆ¶æ™ºèƒ½è®¾å¤‡</p>
                            </div>
                            <div class="ai-chat-messages" id="aiChatMessages">
                                <!-- AIå¯¹è¯æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                            <div class="ai-chat-input">
                                <textarea id="aiChatInput" placeholder="è¾“å…¥æ¶ˆæ¯ä¸å°æœˆå¯¹è¯..." rows="1"></textarea>
                                <div class="ai-input-actions">
                                    <button id="aiSendBtn" class="btn-ai-send">å‘é€</button>
                                    <button id="aiQueryStateBtn" class="btn-ai-query">æŸ¥è¯¢çŠ¶æ€</button>
                                    <button id="aiTTSToggle" class="btn-ai-tts">ğŸ”‡ è¯­éŸ³å…³é—­</button>
                                    <button id="aiClearBtn" class="btn-ai-clear">æ¸…é™¤</button>
                                </div>
                            </div>
                        </div>
                    </section>
                `;

                // åˆå§‹åŒ–AIç®¡ç†å™¨
                this.aiManager = new AIManager();
                this.aiManager.init({
                    chatContainer: document.getElementById('aiChatMessages'),
                    inputBox: document.getElementById('aiChatInput'),
                    sendButton: document.getElementById('aiSendBtn'),
                    queryStateButton: document.getElementById('aiQueryStateBtn'),
                    ttsToggleButton: document.getElementById('aiTTSToggle'),
                    clearButton: document.getElementById('aiClearBtn')
                });

                window.aiManager = this.aiManager;
            }


            switchToControlMode() {
                this.currentMode = 'control';
                this.updateModeButtons('control');

                // ä¿å­˜å½“å‰è¿æ¥é…ç½®ï¼ˆå¦‚æœæœ‰è¾“å…¥æ¡†å­˜åœ¨çš„è¯ï¼‰
                const currentServerUrl = document.getElementById('controlServerUrl');
                const currentServerPort = document.getElementById('controlServerPort');
                if (currentServerUrl) this.wsServer = currentServerUrl.value || this.wsServer;
                if (currentServerPort) this.wsPort = currentServerPort.value || this.wsPort;

                const main = document.getElementById('mainContent');
                main.innerHTML = `
                    <section class="control-section">
                        <div class="control-container">
                            <h2>è®¾å¤‡æ§åˆ¶æ¨¡å¼</h2>

                            <!-- è¿æ¥é…ç½®é¢æ¿ -->
                            <div class="connection-panel">
                                <div class="connection-config">
                                    <div class="config-group">
                                        <label for="controlServerUrl">æœåŠ¡å™¨åœ°å€:</label>
                                        <input type="text" id="controlServerUrl" value="localhost" placeholder="å¦‚: localhost" class="tech-input">
                                    </div>
                                    <div class="config-group">
                                        <label for="controlServerPort">ç«¯å£:</label>
                                        <input type="number" id="controlServerPort" value="8080" placeholder="å¦‚: 8080" class="tech-input">
                                    </div>
                                    <div class="config-group">
                                        <button id="controlConnectBtn" class="btn-primary">è¿æ¥</button>
                                        <button id="controlDisconnectBtn" class="btn-secondary" disabled>æ–­å¼€è¿æ¥</button>
                                        <span id="controlConnectionStatus" class="connection-status disconnected">æœªè¿æ¥</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ğŸ›¡ï¸ è‡ªåŠ¨å®‰é˜²æ¨¡å¼é¢æ¿ -->
                            <div class="device-control-panel" style="margin: 20px 0; border: 1px solid var(--neon-green); background: rgba(0, 255, 157, 0.03);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="border-left-color: var(--neon-green); margin: 0;">ğŸ›¡ï¸ è‡ªåŠ¨å®‰é˜²æ¨¡å¼</h3>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoSafetyToggle" onchange="modeManager.toggleAutoSafety(this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div id="autoSafetyStatus" style="display: none; font-size: 12px; color: var(--neon-green); text-align: center; padding: 10px; background: rgba(0, 255, 157, 0.1); border-radius: 6px; margin-bottom: 15px;">
                                    ğŸ›¡ï¸ è‡ªåŠ¨å®‰é˜²å·²æ¿€æ´» - ç³»ç»Ÿå°†è‡ªåŠ¨å“åº”å¼‚å¸¸
                                </div>
                                
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,0.1);">
                                        <span>ğŸŒ¡ï¸ é«˜æ¸©è­¦æŠ¥</span>
                                        <span style="color: var(--neon-cyan);">æ¸©åº¦ > <strong>28Â°C</strong> â†’ è‡ªåŠ¨å¼€é£æ‰‡</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,0.1);">
                                        <span>ğŸ’§ å›å—å¤©æ¨¡å¼</span>
                                        <span style="color: var(--neon-cyan);">æ¹¿åº¦ > <strong>75%</strong> â†’ è‡ªåŠ¨å…³çª—</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,0.1);">
                                        <span>ğŸ”¥ çƒŸé›¾è­¦æŠ¥</span>
                                        <span style="color: var(--neon-red);">æ£€æµ‹åˆ°çƒŸé›¾ â†’ å…³çª— + è­¦æŠ¥</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                        <span>ğŸ”¥ AIè§†è§‰ç«ç„°</span>
                                        <span style="color: var(--neon-red);">æ‘„åƒå¤´æ£€æµ‹åˆ°ç« â†’ å®‰å…¨æ¨¡å¼</span>
                                    </div>
                                </div>
                            </div>

                            <!-- å‘½ä»¤å‘é€æ—¥å¿— -->
                            <div class="device-control-panel" style="margin: 20px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 style="border:none; padding:0; margin:0; font-size: 1rem;">ğŸ“¡ å‘½ä»¤å‘é€æ—¥å¿—</h3>
                                    <button onclick="clearCommandLog()" class="btn-ai-clear" style="padding: 4px 12px; font-size: 12px;">æ¸…ç©º</button>
                                </div>
                                <div id="commandLog" class="log-container" style="height: 120px;">
                                    <div style="color: var(--text-dim);">ç­‰å¾…å‘é€å‘½ä»¤...</div>
                                </div>
                            </div>

                            <!-- æ™ºèƒ½è®¾å¤‡æ§åˆ¶é¢æ¿ -->
                            <div class="control-panels">
                                <!-- é£æ‰‡æ§åˆ¶é¢æ¿ï¼ˆç”µæœºï¼‰ -->
                                <div class="device-control-panel">
                                    <h3>ğŸŒ€ é£æ‰‡æ§åˆ¶</h3>

                                    <!-- å¼€å…³æŒ‰é’® -->
                                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                        <button id="fanOnBtn" class="btn-primary" onclick="toggleFan(true)" style="flex: 1;">å¼€å¯</button>
                                        <button id="fanOffBtn" class="btn-secondary" onclick="toggleFan(false)" style="flex: 1;">å…³é—­</button>
                                    </div>

                                    <!-- çŠ¶æ€æ˜¾ç¤º -->
                                    <div class="device-status" style="margin-bottom: 16px; text-align: center;">
                                        <span style="font-size: 13px; color: var(--text-secondary);">çŠ¶æ€ï¼š<span id="fanStatus" style="font-weight: 600; color: var(--neon-red);">å…³é—­</span></span>
                                    </div>

                                    <!-- è½¬é€Ÿæ§åˆ¶åŒºåŸŸ -->
                                    <div id="fanControlArea" style="opacity: 0.5; pointer-events: none;">
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">
                                                é£æ‰‡è½¬é€Ÿï¼š<span id="fanSpeedValue">50%</span>
                                            </label>
                                            <input type="range" id="fanSpeed" min="0" max="100" value="50"
                                                   style="width: 100%; accent-color: var(--neon-cyan);" oninput="updateFanSpeed(this.value)">
                                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-dim); margin-top: 4px;">
                                                <span>æœ€å°</span>
                                                <span>æœ€å¤§</span>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">å¿«é€Ÿæ§åˆ¶</label>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn" onclick="setFanSpeed(30)" style="flex: 1; border: 1px solid var(--neon-blue); color: var(--neon-blue); background: rgba(0, 102, 255, 0.1);">ä½é€Ÿ</button>
                                                <button class="btn" onclick="setFanSpeed(50)" style="flex: 1; border: 1px solid var(--neon-blue); color: var(--neon-blue); background: rgba(0, 102, 255, 0.1);">ä¸­é€Ÿ</button>
                                                <button class="btn" onclick="setFanSpeed(100)" style="flex: 1; border: 1px solid var(--neon-blue); color: var(--neon-blue); background: rgba(0, 102, 255, 0.1);">å…¨é€Ÿ</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                                        <span style="font-size: 13px; color: var(--text-secondary);">ç”µæœºPWMå ç©ºæ¯”ï¼š<span id="fanPWM" style="font-weight: 600; color: var(--neon-cyan);">0%</span></span>
                                    </div>
                                </div>

                                <!-- çª—æˆ·æ§åˆ¶é¢æ¿ï¼ˆèˆµæœºï¼‰ -->
                                <div class="device-control-panel">
                                    <h3>ğŸªŸ çª—æˆ·æ§åˆ¶</h3>

                                    <!-- å¼€å…³æŒ‰é’® -->
                                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                        <button id="windowOnBtn" class="btn-primary" onclick="toggleWindow(true)" style="flex: 1;">å¼€å¯</button>
                                        <button id="windowOffBtn" class="btn-secondary" onclick="toggleWindow(false)" style="flex: 1;">å…³é—­</button>
                                    </div>

                                    <!-- çŠ¶æ€æ˜¾ç¤º -->
                                    <div class="device-status" style="margin-bottom: 16px; text-align: center;">
                                        <span style="font-size: 13px; color: var(--text-secondary);">çŠ¶æ€ï¼š<span id="windowStatus" style="font-weight: 600; color: var(--neon-red);">å…³é—­</span></span>
                                    </div>

                                    <!-- è§’åº¦æ§åˆ¶åŒºåŸŸ -->
                                    <div id="windowControlArea" style="opacity: 0.5; pointer-events: none;">
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">
                                                çª—æˆ·å¼€åº¦ï¼š<span id="windowAngleValue">90Â°</span>
                                            </label>
                                            <input type="range" id="windowAngle" min="0" max="180" value="90"
                                                   style="width: 100%; accent-color: var(--neon-magenta);" oninput="updateWindowAngle(this.value)">
                                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-dim); margin-top: 4px;">
                                                <span>å…³é—­ (0Â°)</span>
                                                <span>å…¨å¼€ (180Â°)</span>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">å¿«é€Ÿæ§åˆ¶</label>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn" onclick="setWindowAngle(45)" style="flex: 1; border: 1px solid var(--neon-magenta); color: var(--neon-magenta); background: rgba(188, 19, 254, 0.1);">å°å¼€</button>
                                                <button class="btn" onclick="setWindowAngle(90)" style="flex: 1; border: 1px solid var(--neon-magenta); color: var(--neon-magenta); background: rgba(188, 19, 254, 0.1);">åŠå¼€</button>
                                                <button class="btn" onclick="setWindowAngle(180)" style="flex: 1; border: 1px solid var(--neon-magenta); color: var(--neon-magenta); background: rgba(188, 19, 254, 0.1);">å…¨å¼€</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                                        <span style="font-size: 13px; color: var(--text-secondary);">èˆµæœºè§’åº¦ï¼š<span id="servoPWM" style="font-weight: 600; color: var(--neon-magenta);">0Â°</span></span>
                                    </div>
                                </div>

                                <!-- æŒ‡ç¤ºç¯æ§åˆ¶é¢æ¿ -->
                                <div class="device-control-panel">
                                    <h3>ğŸš¨ çŠ¶æ€æŒ‡ç¤ºç¯</h3>

                                    <!-- å¼€å…³æŒ‰é’® -->
                                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                        <button id="ledOnBtn" class="btn-primary" onclick="toggleIndicatorLight(true)" style="flex: 1; opacity: 0.5;">å¼€å¯</button>
                                        <button id="ledOffBtn" class="btn-secondary" onclick="toggleIndicatorLight(false)" style="flex: 1; opacity: 1;">å…³é—­</button>
                                    </div>

                                    <!-- çŠ¶æ€æ˜¾ç¤º -->
                                    <div class="device-status" style="margin-bottom: 16px; text-align: center;">
                                        <span style="font-size: 13px; color: var(--text-secondary);">ç”µæºï¼š<span id="ledPowerStatus" style="font-weight: 600; color: var(--neon-green);">å¼€å¯</span></span>
                                    </div>

                                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">ğŸš¦ æŒ‡ç¤ºç¯æ ¹æ®ä¼ æ„Ÿå™¨æ•°æ®è‡ªåŠ¨å˜è‰²ï¼š</div>
                                        <div style="font-size: 12px; color: var(--text-dim); line-height: 1.6;">
                                            ğŸŸ¢ ç»¿ç¯ - ç¯å¢ƒæ­£å¸¸ï¼ˆæ¸©åº¦â‰¤30Â°Cï¼Œæ— çƒŸé›¾ï¼‰<br>
                                            ğŸ”´ çº¢ç¯ - è­¦æˆ’çŠ¶æ€ï¼ˆæ¸©åº¦>30Â°C æˆ– çƒŸé›¾æµ“åº¦é«˜ï¼‰
                                        </div>
                                    </div>
                                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 12px;">
                                        <div style="text-align: center; margin-bottom: 8px;">
                                            <span id="indicatorLightColor" style="display: inline-block; width: 60px; height: 60px; border-radius: 50%; background: var(--neon-green); box-shadow: 0 0 20px rgba(0, 255, 157, 0.6);"></span>
                                        </div>
                                        <div style="text-align: center;">
                                            <span id="indicatorLightStatus" style="font-size: 13px; font-weight: 600; color: var(--neon-green);">çŠ¶æ€ï¼šæ­£å¸¸</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                `;

                // è®¾ç½®æ§åˆ¶æ¨¡å¼çš„äº‹ä»¶å¤„ç†
                this.setupControlModeEvents();

                // åŒæ­¥è¿æ¥é…ç½®åˆ°è¾“å…¥æ¡†
                document.getElementById('controlServerUrl').value = this.wsServer;
                document.getElementById('controlServerPort').value = this.wsPort;

                // å¦‚æœå·²è¿æ¥ï¼Œæ›´æ–°UIçŠ¶æ€
                if (this.isConnected) {
                    this.updateConnectionStatus(true);

                    // æ¢å¤æœ€åçš„æ¸©åº¦æ•°æ®
                    if (this.lastSensorData && this.lastSensorData.temperature !== undefined) {
                        const tempEl = document.getElementById('acCurrentTemp');
                        if (tempEl) {
                            tempEl.textContent = `${this.lastSensorData.temperature.toFixed(1)}Â°C`;
                        }
                    }
                }
            }

            switchToSensorMode() {
                this.currentMode = 'sensor';
                this.updateModeButtons('sensor');

                // ä¿å­˜å½“å‰è¿æ¥é…ç½®
                const currentServerUrl = document.getElementById('sensorServerUrl');
                const currentServerPort = document.getElementById('sensorServerPort');
                if (currentServerUrl) this.wsServer = currentServerUrl.value || this.wsServer;
                if (currentServerPort) this.wsPort = currentServerPort.value || this.wsPort;

                const main = document.getElementById('mainContent');
                main.innerHTML = `
                    <section class="sensor-section">
                        <div class="connection-panel">
                            <div class="connection-config">
                                <div class="config-group">
                                    <label>æœåŠ¡å™¨:</label>
                                    <input type="text" id="sensorServerUrl" value="localhost" class="tech-input">
                                </div>
                                <div class="config-group">
                                    <label>ç«¯å£:</label>
                                    <input type="number" id="sensorServerPort" value="8080" class="tech-input">
                                </div>
                                <button id="sensorConnectBtn" class="btn-primary">è¿æ¥</button>
                                <button id="sensorDisconnectBtn" class="btn-secondary" disabled>æ–­å¼€</button>
                                <button id="sensorSimulateBtn" class="btn-secondary" style="margin-left: 10px; border-color: var(--neon-magenta); color: var(--neon-magenta);">ğŸ§ª æ¨¡æ‹Ÿ</button>
                                <span id="sensorStatus" class="status-indicator disconnected">æœªè¿æ¥</span>
                            </div>
                        </div>

                        <div class="sensor-grid device-cards-container">
                            <!-- æ¸©åº¦å¡ç‰‡ -->
                            <div class="device-card" id="tempCard">
                                <svg class="tech-icon" viewBox="0 0 24 24">
                                    <path d="M12 2C9.79 2 8 3.79 8 6v5c0 1.1-.9 2-2 2H4c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2v-5l2-2h4c1.1 0 2-.9 2-2V6c0-2.21-1.79-4-4-4zm-4 17H6v-2h2v2zm0-4H6v-2h2v2zm10-6h-2V7h2v2z" opacity="0.5"/>
                                    <path d="M15 11V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6l-2 2v6c0 2.21 1.79 4 4 4s4-1.79 4-4v-6l-2-2z"/>
                                </svg>
                                <div class="detail-label">æ¸©åº¦</div>
                                <div id="temperature" style="font-size: 36px; font-weight: 600; color: var(--text-primary);">--</div>
                                <div class="detail-label">Â°C</div>
                            </div>

                            <!-- æ¹¿åº¦å¡ç‰‡ -->
                            <div class="device-card" id="humidityCard">
                                <svg class="tech-icon" viewBox="0 0 24 24">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7zm0 10.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    <path d="M12 22c4.97 0 9-4.03 9-9 0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9z" opacity="0.3"/>
                                </svg>
                                <div class="detail-label">æ¹¿åº¦</div>
                                <div id="humidity" style="font-size: 36px; font-weight: 600; color: var(--text-primary);">--</div>
                                <div class="detail-label">%</div>
                            </div>

                            <!-- çƒŸé›¾æ£€æµ‹å¡ç‰‡ -->
                            <div class="device-card" id="smokeCard">
                                <svg class="tech-icon" viewBox="0 0 24 24">
                                    <path d="M19.66 11.23l-1.34-2.68-2.68 1.34c-.16.08-.34.12-.51.12-.51 0-.97-.33-1.12-.83l-1.33-4.48-1.34 4.47c-.15.49-.61.83-1.12.83-.17 0-.35-.04-.51-.12l-2.68-1.34-1.34 2.68c-.2.4-.64.63-1.08.57-.44-.06-.81-.36-.91-.79l-.89-3.56c-.52 2.76-2.54 5.92-2.79 8.27-.61 5.61 5.22 8.5 7.97 4.08.38-.61.73-.24.79-.1 2.3 5.56 8.58 2.37 7.98-3.09-.27-2.45-2.28-5.61-2.79-8.37l-.92 3.66c-.1.43-.46.73-.91.79-.42.06-.86-.17-1.06-.55z"/>
                                </svg>
                                <div class="detail-label">çƒŸé›¾æ£€æµ‹</div>
                                <div id="smokeVoltage" style="font-size: 28px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">-- V</div>
                                <span id="smokeIndicator" class="status-indicator connected">âœ“ æ­£å¸¸</span>
                            </div>

                            <!-- å…‰ç…§å¼ºåº¦å¡ç‰‡ -->
                            <div class="device-card" id="lightCard">
                                <svg class="tech-icon" viewBox="0 0 24 24">
                                    <path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V21.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.79-1.41-1.41-1.79 1.79z"/>
                                </svg>
                                <div class="detail-label">å…‰ç…§å¼ºåº¦</div>
                                <div id="lightIntensity" style="font-size: 36px; font-weight: 600; color: var(--text-primary);">--</div>
                                <div class="detail-label">%</div>
                            </div>

                            <!-- CO2æµ“åº¦å¡ç‰‡ -->
                            <div class="device-card" id="co2Card">
                                <svg class="tech-icon" viewBox="0 0 24 24">
                                    <path d="M17 16h-4v-4h4v4zm2 2H5V6h14v12zM5 4h14c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" opacity="0.5"/>
                                    <text x="12" y="14" text-anchor="middle" font-size="6" fill="currentColor">COâ‚‚</text>
                                </svg>
                                <div class="detail-label">COâ‚‚ æµ“åº¦</div>
                                <div id="co2Value" style="font-size: 36px; font-weight: 600; color: var(--text-primary);">--</div>
                                <div class="detail-label">ppm</div>
                            </div>
                        </div>

                        <!-- æ•°æ®æ›²çº¿å›¾ -->
                        <div class="device-control-panel" style="margin-top: 30px;">
                            <h3>ğŸ“ˆ ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿</h3>
                            <canvas id="sensorChart" style="max-height: 300px;"></canvas>
                        </div>

                        <div style="text-align: center; margin-top: 30px; font-size: 14px; color: var(--text-dim);" id="sensorTimestamp"></div>

                        <div class="device-control-panel" style="margin-top: 20px;">
                            <h3>ğŸ“Š ç³»ç»Ÿæ—¥å¿—</h3>
                            <div id="sensorLogContainer" class="log-container"></div>
                        </div>
                    </section>
                `;

                this.setupSensorMode();

                // åŒæ­¥è¿æ¥é…ç½®åˆ°è¾“å…¥æ¡†
                document.getElementById('sensorServerUrl').value = this.wsServer;
                document.getElementById('sensorServerPort').value = this.wsPort;

                // å¦‚æœå·²è¿æ¥ï¼Œæ›´æ–°UIçŠ¶æ€
                if (this.isConnected) {
                    this.updateConnectionStatus(true);
                    this.sensorLog('âœ… å·²è¿æ¥åˆ°ä¸‹ä½æœº');

                    // æ¢å¤æœ€åçš„ä¼ æ„Ÿå™¨æ•°æ®
                    if (this.lastSensorData) {
                        this.updateSensorDisplay(this.lastSensorData);
                        this.sensorLog('ğŸ“Š å·²æ¢å¤æœ€åçš„æ•°æ®æ˜¾ç¤º');
                    }
                }
            }

            setupSensorMode() {
                const connectBtn = document.getElementById('sensorConnectBtn');
                const disconnectBtn = document.getElementById('sensorDisconnectBtn');

                connectBtn.addEventListener('click', () => this.connectSensor());
                disconnectBtn.addEventListener('click', () => this.disconnectSensor());

                const simulateBtn = document.getElementById('sensorSimulateBtn');
                if (simulateBtn) {
                    simulateBtn.addEventListener('click', () => this.simulateSensorData());
                }

                // åˆå§‹åŒ–å›¾è¡¨
                this.initChart();

                // åˆå§‹åŒ–æ—¥å¿—
                this.sensorLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                this.sensorLog('ğŸ“ˆ æ•°æ®æ›²çº¿å›¾å·²åŠ è½½');
            }

            sensorLog(message) {
                const logContainer = document.getElementById('sensorLogContainer');
                if (logContainer) {
                    const time = new Date().toLocaleTimeString('zh-CN');
                    logContainer.innerHTML += `[${time}] ${message}<br>`;
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            }

            connectSensor() {
                const url = document.getElementById('sensorServerUrl').value || 'localhost';
                const port = document.getElementById('sensorServerPort').value || '8080';

                this.sensorLog(`è¿æ¥åˆ° ws://${url}:${port}...`);

                // ä½¿ç”¨å…±äº«è¿æ¥
                this.connectSharedWebSocket(url, port);

                // è¿æ¥æˆåŠŸåæ˜¾ç¤ºæ—¥å¿—
                if (this.isConnected) {
                    this.sensorLog('âœ… WebSocketè¿æ¥æˆåŠŸ');
                }
            }

            disconnectSensor() {
                this.sensorLog('æ–­å¼€è¿æ¥');
                // ä½¿ç”¨å…±äº«æ–­å¼€
                this.disconnectSharedWebSocket();
            }

            simulateSensorData() {
                const btn = document.getElementById('sensorSimulateBtn');
                if (this.simulationTimer) {
                    clearInterval(this.simulationTimer);
                    this.simulationTimer = null;
                    if (btn) {
                        btn.textContent = 'ğŸ§ª æ¨¡æ‹Ÿ';
                        btn.style.backgroundColor = '';
                        btn.style.color = '#bc13fe';
                        btn.style.boxShadow = '';
                    }
                    this.sensorLog('â¹ï¸ æ¨¡æ‹Ÿæ•°æ®å·²åœæ­¢');
                } else {
                    this.sensorLog('ğŸ§ª æ¨¡æ‹Ÿæ•°æ®å·²å¯åŠ¨');
                    if (btn) {
                        btn.textContent = 'â¹ï¸ å…³é—­æ¨¡æ‹Ÿ';
                        btn.style.backgroundColor = 'rgba(255, 59, 48, 0.2)'; // Red tint for stop action
                        btn.style.color = '#ff3b30'; // Red text
                        btn.style.borderColor = '#ff3b30';
                        btn.style.boxShadow = '0 0 15px rgba(255, 59, 48, 0.4)';
                    }

                    this.simulationTimer = setInterval(() => {
                        const fakeData = {
                            temperature: 20 + Math.random() * 10 - 2,
                            humidity: 50 + Math.random() * 20 - 10,
                            smoke_voltage: 0.2 + Math.random() * 0.1,
                            smoke_detected: false,
                            light_intensity: 30 + Math.random() * 50,
                            co2_ppm: Math.floor(400 + Math.random() * 600)  // 400-1000 ppm
                        };

                        // å¶å°”è§¦å‘æŠ¥è­¦
                        if (Math.random() > 0.95) {
                            fakeData.smoke_detected = true;
                            fakeData.smoke_voltage = 2.5;
                        }

                        this.updateSensorDisplay(fakeData);
                    }, 1500);
                }
            }

            updateSensorDisplay(data) {
                // å®‰å…¨åœ°æ›´æ–°DOMå…ƒç´ ï¼ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼‰
                const updateElement = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };

                // æ›´æ–°æ¸©åº¦ï¼ˆå‚è€ƒSensorCard.jsxçš„å˜è‰²é€»è¾‘ï¼‰
                if (data.temperature !== undefined) {
                    updateElement('temperature', data.temperature.toFixed(1));
                    const tempCard = document.getElementById('tempCard');
                    if (tempCard) {
                        if (data.temperature < 20) {
                            tempCard.className = 'device-card'; // Reset
                            tempCard.style.borderColor = '#00f3ff'; // è“è‰²
                            tempCard.style.boxShadow = '0 0 15px rgba(0, 243, 255, 0.2)';
                        } else if (data.temperature > 26) {
                            tempCard.className = 'device-card';
                            tempCard.style.borderColor = '#ff0055'; // çº¢è‰²
                            tempCard.style.boxShadow = '0 0 15px rgba(255, 0, 85, 0.3)';
                        } else {
                            tempCard.className = 'device-card device-on'; // ç»¿è‰²æ­£å¸¸
                            tempCard.style.borderColor = ''; // æ¸…é™¤å¼ºåˆ¶è¦†ç›–
                            tempCard.style.boxShadow = '';
                        }
                    }
                }

                // æ›´æ–°æ¹¿åº¦
                if (data.humidity !== undefined) {
                    updateElement('humidity', data.humidity);
                    const humidityCard = document.getElementById('humidityCard');
                    if (humidityCard) {
                        if (data.humidity < 30 || data.humidity > 70) {
                            humidityCard.style.borderColor = '#ffcc00'; // é»„è‰²è­¦å‘Š
                        } else {
                            humidityCard.className = 'device-card device-on'; // æ­£å¸¸
                            humidityCard.style.borderColor = '';
                        }
                    }
                }

                // æ›´æ–°çƒŸé›¾
                if (data.smoke_voltage !== undefined) {
                    updateElement('smokeVoltage', data.smoke_voltage.toFixed(2) + ' V');
                }
                if (data.smoke_detected !== undefined) {
                    const indicatorEl = document.getElementById('smokeIndicator');
                    const smokeCard = document.getElementById('smokeCard');
                    if (indicatorEl) {
                        if (data.smoke_detected) {
                            indicatorEl.textContent = 'âš ï¸ è­¦å‘Š';
                            indicatorEl.className = 'status-indicator disconnected';
                            if (smokeCard) {
                                smokeCard.style.borderColor = '#ff0055';
                                smokeCard.style.boxShadow = '0 0 20px rgba(255, 0, 85, 0.4)';
                            }
                        } else {
                            indicatorEl.textContent = 'âœ“ æ­£å¸¸';
                            indicatorEl.className = 'status-indicator connected';
                            if (smokeCard) {
                                smokeCard.className = 'device-card device-on';
                                smokeCard.style.borderColor = '';
                                smokeCard.style.boxShadow = '';
                            }
                        }
                    }
                }

                // æ›´æ–°å…‰ç…§å¼ºåº¦
                if (data.light_intensity !== undefined) {
                    updateElement('lightIntensity', data.light_intensity.toFixed(1));
                    const lightCard = document.getElementById('lightCard');
                    if (lightCard) {
                        lightCard.className = 'device-card device-on'; // é»˜è®¤å¼€å¯äº®èµ·
                    }
                }

                // æ›´æ–°CO2æµ“åº¦
                if (data.co2_ppm !== undefined) {
                    updateElement('co2Value', data.co2_ppm);
                    const co2Card = document.getElementById('co2Card');
                    if (co2Card) {
                        if (data.co2_ppm > 1000) {
                            // CO2è¿‡é«˜ï¼Œéœ€è¦é€šé£
                            co2Card.style.borderColor = '#ff0055';
                            co2Card.style.boxShadow = '0 0 15px rgba(255, 0, 85, 0.3)';
                        } else if (data.co2_ppm > 800) {
                            // CO2è¾ƒé«˜ï¼Œè­¦å‘Š
                            co2Card.style.borderColor = '#ffcc00';
                            co2Card.style.boxShadow = '0 0 15px rgba(255, 204, 0, 0.3)';
                        } else {
                            // CO2æ­£å¸¸
                            co2Card.className = 'device-card device-on';
                            co2Card.style.borderColor = '';
                            co2Card.style.boxShadow = '';
                        }
                    }
                }

                // æ›´æ–°å›¾è¡¨
                this.updateChart(data);

                // æ ¹æ®ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°æŒ‡ç¤ºç¯é¢œè‰²ï¼ˆæ¸©åº¦>30Â°C æˆ– çƒŸé›¾é«˜ â†’ çº¢ç¯ï¼‰
                if (typeof updateIndicatorLightFromSensorData === 'function') {
                    updateIndicatorLightFromSensorData(data);
                }

                // æ›´æ–°æ—¶é—´æˆ³
                const timestampEl = document.getElementById('sensorTimestamp');
                if (timestampEl) {
                    timestampEl.textContent = `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
                }

                // ========== è‡ªåŠ¨å®‰é˜²è§„åˆ™æ£€æŸ¥ ==========
                if (this.autoSafetyEnabled) {
                    this.evaluateAutomationRules(data);
                }
            }

            // ========== è‡ªåŠ¨åŒ–è§„åˆ™è¯„ä¼°å¼•æ“ ==========
            evaluateAutomationRules(data) {
                const now = Date.now();

                // è§„åˆ™1: é«˜æ¸© â†’ å¼€é£æ‰‡
                if (this.autoRules.highTemperature.enabled && data.temperature !== undefined) {
                    if (data.temperature > this.autoRules.highTemperature.threshold) {
                        this.triggerAutoAction('highTemp', 'ğŸŒ¡ï¸ é«˜æ¸©è­¦æŠ¥',
                            `æ¸©åº¦ ${data.temperature.toFixed(1)}Â°C è¶…è¿‡é˜ˆå€¼ ${this.autoRules.highTemperature.threshold}Â°C`,
                            () => {
                                // å¼€å¯é£æ‰‡
                                if (typeof toggleFan === 'function') toggleFan(true);
                                if (typeof setFanSpeed === 'function') setFanSpeed(80);
                            });
                    }
                }

                // è§„åˆ™2: é«˜æ¹¿åº¦(å›å—å¤©) â†’ å…³çª—
                if (this.autoRules.highHumidity.enabled && data.humidity !== undefined) {
                    if (data.humidity > this.autoRules.highHumidity.threshold) {
                        this.triggerAutoAction('highHumidity', 'ğŸ’§ å›å—å¤©æ¨¡å¼',
                            `æ¹¿åº¦ ${data.humidity}% è¶…è¿‡é˜ˆå€¼ ${this.autoRules.highHumidity.threshold}%ï¼Œè‡ªåŠ¨å…³çª—é˜²æ½®`,
                            () => {
                                // å…³é—­çª—æˆ· (èˆµæœºå½’é›¶)
                                if (typeof toggleWindow === 'function') toggleWindow(false);
                            });
                    }
                }

                // è§„åˆ™3: çƒŸé›¾æ£€æµ‹ â†’ å®‰å…¨æ¨¡å¼
                if (this.autoRules.fireDetection.enabled && data.smoke_detected) {
                    this.triggerAutoAction('smokeDetected', 'ğŸ”¥ çƒŸé›¾è­¦æŠ¥',
                        'æ£€æµ‹åˆ°çƒŸé›¾ï¼Œå¯åŠ¨å®‰å…¨æ¨¡å¼ï¼šå…³çª— + çº¢è‰²è­¦æŠ¥',
                        () => {
                            // å…³é—­çª—æˆ·
                            if (typeof toggleWindow === 'function') toggleWindow(false);
                            // è¿™é‡Œå¯ä»¥æ·»åŠ è­¦æŠ¥ç¯æ§åˆ¶
                        });
                }
            }

            // è§¦å‘è‡ªåŠ¨åŠ¨ä½œï¼ˆå¸¦å†·å´é˜²æŠ–ï¼‰
            triggerAutoAction(ruleId, title, message, actionFn) {
                const now = Date.now();
                const lastTrigger = this.ruleCooldowns[ruleId] || 0;

                // å†·å´æ—¶é—´å†…ä¸é‡å¤è§¦å‘
                if (now - lastTrigger < this.cooldownTime) {
                    return;
                }

                this.ruleCooldowns[ruleId] = now;

                // æ‰§è¡ŒåŠ¨ä½œ
                console.log(`ğŸ¤– [è‡ªåŠ¨å®‰é˜²] ${title}: ${message}`);
                if (actionFn) actionFn();

                // æ˜¾ç¤ºé€šçŸ¥
                this.showAutoActionNotification(title, message);

                // è®°å½•åˆ°æ—¥å¿—
                this.logAutoAction(title, message);
            }

            // æ˜¾ç¤ºè‡ªåŠ¨åŠ¨ä½œé€šçŸ¥
            showAutoActionNotification(title, message) {
                // åˆ›å»ºæµ®åŠ¨é€šçŸ¥
                const notification = document.createElement('div');
                notification.className = 'auto-action-notification';
                notification.innerHTML = `
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                    <div class="notification-badge">ğŸ¤– è‡ªåŠ¨æ‰§è¡Œ</div>
                `;
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: linear-gradient(135deg, rgba(0, 255, 157, 0.15), rgba(0, 100, 80, 0.2));
                    border: 1px solid var(--neon-green);
                    border-left: 4px solid var(--neon-green);
                    border-radius: 8px;
                    padding: 15px 20px;
                    min-width: 300px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 255, 157, 0.2);
                    z-index: 10001;
                    animation: slideInRight 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
                    font-family: var(--font-tech);
                `;

                document.body.appendChild(notification);

                // 5ç§’åç§»é™¤
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }

            // è®°å½•è‡ªåŠ¨åŠ¨ä½œåˆ°å‘½ä»¤æ—¥å¿—
            logAutoAction(title, message) {
                const logEl = document.getElementById('commandLog');
                if (logEl) {
                    const time = new Date().toLocaleTimeString();
                    const entry = document.createElement('div');
                    entry.style.cssText = 'color: var(--neon-green); margin-bottom: 5px; border-left: 3px solid var(--neon-green); padding-left: 8px;';
                    entry.innerHTML = `<span style="color: var(--text-dim);">[${time}]</span> ğŸ¤– <strong>${title}</strong>: ${message}`;
                    logEl.insertBefore(entry, logEl.firstChild);
                }
            }

            // åˆ‡æ¢è‡ªåŠ¨å®‰é˜²æ¨¡å¼
            toggleAutoSafety(enabled) {
                this.autoSafetyEnabled = enabled;
                console.log(`ğŸ›¡ï¸ è‡ªåŠ¨å®‰é˜²æ¨¡å¼: ${enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);

                const statusEl = document.getElementById('autoSafetyStatus');
                if (statusEl) {
                    statusEl.style.display = enabled ? 'block' : 'none';
                    statusEl.textContent = enabled ? 'ğŸ›¡ï¸ è‡ªåŠ¨å®‰é˜²å·²æ¿€æ´» - ç³»ç»Ÿå°†è‡ªåŠ¨å“åº”å¼‚å¸¸' : '';
                }
            }

            // å›¾è¡¨ç›¸å…³æ–¹æ³•ï¼ˆå‚è€ƒDataChart.jsxï¼‰
            initChart() {
                const canvas = document.getElementById('sensorChart');
                if (!canvas) return;

                // é”€æ¯æ—§å›¾è¡¨å®ä¾‹ï¼Œé¿å…å†…å­˜æ³„æ¼
                if (this.chart) {
                    this.chart.destroy();
                    this.chart = null;
                }

                const ctx = canvas.getContext('2d');

                // æ•°æ®æŒä¹…åŒ–ï¼šå¦‚æœå·²æœ‰æ•°æ®ï¼Œåˆ™å¤ç”¨ï¼Œé¿å…åˆ‡æ¢æ¨¡å¼æ—¶ä¸¢å¤±
                if (!this.chartData) {
                    // åˆå§‹åŒ–å›¾è¡¨æ•°æ®ï¼ˆæœ€å¤šä¿ç•™500ä¸ªæ•°æ®ç‚¹ï¼Œçº¦40åˆ†é’Ÿå†å²ï¼‰
                    this.chartData = {
                        labels: [],
                        datasets: [
                            {
                                label: 'æ¸©åº¦ (Â°C)',
                                data: [],
                                borderColor: '#ff0055', // Neon Red
                                backgroundColor: 'rgba(255, 0, 85, 0.1)',
                                tension: 0.5,
                                cubicInterpolationMode: 'monotone',
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'æ¹¿åº¦ (%)',
                                data: [],
                                borderColor: '#00f3ff', // Neon Cyan
                                backgroundColor: 'rgba(0, 243, 255, 0.1)',
                                tension: 0.5,
                                cubicInterpolationMode: 'monotone',
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                hidden: true
                            },
                            {
                                label: 'çƒŸé›¾ (V)',
                                data: [],
                                borderColor: '#bc13fe', // Neon Magenta
                                backgroundColor: 'rgba(188, 19, 254, 0.1)',
                                tension: 0.5,
                                cubicInterpolationMode: 'monotone',
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                hidden: true
                            },
                            {
                                label: 'å…‰ç…§ (%)',
                                data: [],
                                borderColor: '#00ff9d', // Neon Green
                                backgroundColor: 'rgba(0, 255, 157, 0.1)',
                                tension: 0.5,
                                cubicInterpolationMode: 'monotone',
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                hidden: true
                            },
                            {
                                label: 'COâ‚‚ (ppm)',
                                data: [],
                                borderColor: '#ffaa00', // Orange
                                backgroundColor: 'rgba(255, 170, 0, 0.1)',
                                tension: 0.5,
                                cubicInterpolationMode: 'monotone',
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                hidden: false
                            }
                        ]
                    };
                }

                // åˆ›å»ºChartå®ä¾‹ - èµ›åšæœ‹å…‹é£æ ¼
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: this.chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1500, // ä¸æ•°æ®æ›´æ–°é¢‘ç‡ä¸€è‡´ï¼Œå½¢æˆè¿ç»­æµåŠ¨
                            easing: 'linear' // çº¿æ€§åŒ€é€ŸæµåŠ¨
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#e0e6ed',
                                    usePointStyle: true,
                                    font: { family: "'JetBrains Mono', monospace" }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(5, 5, 16, 0.9)',
                                titleColor: '#00f3ff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(0, 243, 255, 0.3)',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 243, 255, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#64748b',
                                    font: { family: "'JetBrains Mono', monospace" }
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: {
                                    color: '#64748b',
                                    font: { family: "'JetBrains Mono', monospace" },
                                    maxRotation: 0
                                }
                            }
                        }
                    }
                });

                // åº”ç”¨æ¸å˜å¡«å…… (Chart.js quirk: need to assign after creation or use scriptable)
                // è¿™é‡Œç®€å•å¤„ç†ï¼šç›´æ¥æ›´æ–°datasetçš„backgroundColorä¸ºæ¸å˜å¯¹è±¡
                try {
                    const createGradient = (colorStart, colorEnd) => {
                        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                        gradient.addColorStop(0, colorStart);
                        gradient.addColorStop(1, colorEnd);
                        return gradient;
                    };

                    this.chart.data.datasets[0].backgroundColor = createGradient('rgba(255, 0, 85, 0.5)', 'rgba(255, 0, 85, 0)');
                    this.chart.data.datasets[1].backgroundColor = createGradient('rgba(0, 243, 255, 0.5)', 'rgba(0, 243, 255, 0)');
                    this.chart.data.datasets[2].backgroundColor = createGradient('rgba(188, 19, 254, 0.5)', 'rgba(188, 19, 254, 0)');
                    this.chart.data.datasets[3].backgroundColor = createGradient('rgba(0, 255, 157, 0.5)', 'rgba(0, 255, 157, 0)');

                    this.chart.update();
                } catch (e) {
                    console.warn('Gradient application failed', e);
                }
            }

            updateChart(data) {
                if (!this.chart || !this.chartData || !data) return;

                const timeLabel = new Date().toLocaleTimeString('zh-CN', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });

                this.chartData.labels.push(timeLabel);
                // ä¿®å¤ï¼šå…è®¸æ•°å€¼0è¢«ç»˜åˆ¶ï¼Œè€Œä¸æ˜¯å˜æˆnullï¼ˆæ–­çº¿ï¼‰
                this.chartData.datasets[0].data.push(data.temperature !== null && data.temperature !== undefined ? data.temperature : null);
                this.chartData.datasets[1].data.push(data.humidity !== null && data.humidity !== undefined ? data.humidity : null);
                this.chartData.datasets[2].data.push(data.smoke_voltage !== null && data.smoke_voltage !== undefined ? data.smoke_voltage * 10 : null);
                this.chartData.datasets[3].data.push(data.light_intensity !== null && data.light_intensity !== undefined ? data.light_intensity : null);
                this.chartData.datasets[4].data.push(data.co2_ppm !== null && data.co2_ppm !== undefined ? data.co2_ppm / 10 : 0);  // CO2å¦‚æœä¸º0æˆ–æ— æ•ˆï¼Œæ˜¾ç¤ºä¸º0è€Œä¸ç•™ç™½

                if (this.chartData.labels.length > 500) {
                    this.chartData.labels.shift();
                    this.chartData.datasets.forEach(ds => ds.data.shift());
                }

                this.chart.update(); // å¯ç”¨åŠ¨ç”»æ›´æ–°ä»¥å±•ç¤ºå¼¹æ€§æ•ˆæœ
            }

            updateModeButtons(activeMode) {
                const buttons = document.querySelectorAll('.btn-switch');
                buttons.forEach((btn, index) => {
                    btn.classList.remove('active');
                    if (
                        (activeMode === 'ai' && index === 0) ||
                        (activeMode === 'sensor' && index === 1) ||
                        (activeMode === 'control' && index === 2) ||
                        (activeMode === 'vision' && index === 3)
                    ) {
                        btn.classList.add('active');
                    }
                });
            }

            setupControlModeEvents() {
                // è®¾å¤‡æ§åˆ¶æŒ‰é’®äº‹ä»¶
                const controlButtons = document.querySelectorAll('.control-btn[data-cmd]');
                controlButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const command = btn.getAttribute('data-cmd');
                        this.sendDeviceCommand(command);
                    });
                });

                // è¿æ¥æŒ‰é’®
                const controlConnectBtn = document.getElementById('controlConnectBtn');
                const controlDisconnectBtn = document.getElementById('controlDisconnectBtn');

                if (controlConnectBtn) {
                    controlConnectBtn.addEventListener('click', () => {
                        this.connectToControlDevice();
                    });
                }

                if (controlDisconnectBtn) {
                    controlDisconnectBtn.addEventListener('click', () => {
                        this.disconnectFromControlDevice();
                    });
                }

                // åˆå§‹åŒ–æ™ºèƒ½ç¯å¼€å…³UIï¼ˆé»˜è®¤å¼€å¯ï¼‰
                const smartLightSwitch = document.getElementById('smartLightSwitch');
                if (smartLightSwitch && smartLightState) {
                    smartLightSwitch.classList.add('on');
                }
            }

            sendDeviceCommand(command) {
                console.log('å‘é€è®¾å¤‡å‘½ä»¤:', command);
                // è¿™é‡Œå¯ä»¥é€šè¿‡WebSocketå‘é€å‘½ä»¤ç»™ä¸‹ä½æœº
                // å¦‚æœéœ€è¦,å¯ä»¥å¤ç”¨è°ƒè¯•æ¨¡å¼çš„è¿æ¥ç®¡ç†å™¨
                if (window.aiManager && window.aiManager.isConnected) {
                    const message = {
                        type: "message",
                        timestamp: Date.now(),
                        data: command
                    };
                    // å‘é€å‘½ä»¤é€»è¾‘
                } else {
                    alert('è¯·å…ˆè¿æ¥åˆ°è®¾å¤‡');
                }
            }

            connectToControlDevice() {
                const serverUrl = document.getElementById('controlServerUrl').value.trim() || 'localhost';
                const serverPort = document.getElementById('controlServerPort').value.trim() || '8080';

                // ä½¿ç”¨å…±äº«è¿æ¥
                this.connectSharedWebSocket(serverUrl, serverPort);
            }

            disconnectFromControlDevice() {
                // ä½¿ç”¨å…±äº«æ–­å¼€
                this.disconnectSharedWebSocket();
            }

            switchToVisionMode() {
                this.currentMode = 'vision';
                this.updateModeButtons('vision');

                const main = document.getElementById('mainContent');
                main.innerHTML = `
                    <section class="vision-section">
                        <div class="vision-container" style="max-width: 1400px; margin: 0 auto;">
                            <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 20px;">ğŸ¥ å®æ—¶è§†è§‰æ£€æµ‹</h2>

                            <!-- çŠ¶æ€æ  -->
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: rgba(0, 243, 255, 0.05); border-radius: 10px; margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div id="visionStatusDot" style="width: 12px; height: 12px; border-radius: 50%; background: var(--neon-red);"></div>
                                    <span id="visionStatusText">æœªè¿æ¥</span>
                                </div>
                                <div style="display: flex; gap: 20px;">
                                    <span id="visionFpsCounter">FPS: 0</span>
                                    <span id="visionLatencyCounter">å»¶è¿Ÿ: 0ms</span>
                                </div>
                            </div>

                            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px;">
                                <!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
                                <div style="position: relative; background: #000; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
                                    <canvas id="visionCanvas" width="640" height="480" style="width: 100%; height: auto; display: block;"></canvas>
                                    <div style="position: absolute; top: 15px; left: 15px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px;">
                                        <div id="visionFrameInfo">ç­‰å¾…è§†é¢‘æµ...</div>
                                    </div>
                                </div>

                                <!-- æ£€æµ‹é¢æ¿ -->
                                <div style="background: rgba(0, 243, 255, 0.05); border-radius: 15px; padding: 25px;">
                                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                        <div id="visionHumanCard" class="device-card" style="text-align: center; padding: 20px;">
                                            <div id="visionHumanCount" style="font-size: 2.5em; font-weight: bold; color: var(--neon-blue);">0</div>
                                            <div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;">ğŸ‘¤ æ£€æµ‹åˆ°äºº</div>
                                        </div>
                                        <div id="visionFireCard" class="device-card" style="text-align: center; padding: 20px;">
                                            <div id="visionFireCount" style="font-size: 2.5em; font-weight: bold; color: var(--neon-red);">0</div>
                                            <div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;">ğŸ”¥ æ£€æµ‹åˆ°ç«</div>
                                        </div>
                                    </div>

                                    <!-- æ£€æµ‹æ—¥å¿— -->
                                    <div class="device-card" style="padding: 15px;">
                                        <h3 style="margin-bottom: 10px; font-size: 1.1em;">æ£€æµ‹æ—¥å¿—</h3>
                                        <div id="visionLogContainer" class="log-container" style="max-height: 300px; overflow-y: auto;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ§åˆ¶æŒ‰é’® -->
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button id="visionConnectBtn" class="btn-primary" style="display: none;">è¿æ¥</button>
                                <button id="visionDisconnectBtn" class="btn-secondary" style="display: none;">æ–­å¼€</button>
                            </div>

                            <!-- è°ƒè¯•ä¿¡æ¯ -->
                            <div id="visionDebugInfo" class="log-container" style="margin-top: 20px; font-family: monospace; font-size: 0.85em; max-height: 150px;"></div>
                        </div>
                    </section>
                `;

                // åˆå§‹åŒ–è§†è§‰æ£€æµ‹
                this.setupVisionMode();
            }

            setupVisionMode() {
                // åˆå§‹åŒ–Canvas
                this.visionCanvas = document.getElementById('visionCanvas');
                this.visionCtx = this.visionCanvas ? this.visionCanvas.getContext('2d') : null;
                this.visionFrameCount = 0;
                this.visionLastFrameTime = Date.now();

                // è‡ªåŠ¨ä½¿ç”¨å…±äº«è¿æ¥
                if (this.isConnected) {
                    this.updateVisionStatus(true);
                    this.addVisionDebug('âœ… å·²ä½¿ç”¨å…±äº«WebSocketè¿æ¥');
                    this.addVisionLog('ç³»ç»Ÿ', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                } else {
                    // è‡ªåŠ¨è¿æ¥
                    this.addVisionDebug('ğŸ”— è‡ªåŠ¨è¿æ¥WebSocket...');
                    this.connectSharedWebSocket(this.wsServer, this.wsPort);
                }

                // æ·»åŠ æ¶ˆæ¯å¤„ç†ï¼ˆå¤ç”¨sharedWsçš„onmessageï¼Œä½†è¿™é‡Œéœ€è¦é’ˆå¯¹visionæ¨¡å¼çš„å¤„ç†ï¼‰
                // æ³¨æ„ï¼šç”±äºå…±äº«è¿æ¥ï¼Œonmessageå·²ç»åœ¨connectSharedWebSocketä¸­è®¾ç½®
                // æˆ‘ä»¬éœ€è¦åœ¨é‚£é‡Œæ·»åŠ å¯¹visionæ¨¡å¼çš„æ”¯æŒ
            }

            updateVisionStatus(connected) {
                const statusDot = document.getElementById('visionStatusDot');
                const statusText = document.getElementById('visionStatusText');

                if (statusDot && statusText) {
                    if (connected) {
                        statusDot.style.background = 'var(--neon-green)';
                        statusDot.style.boxShadow = '0 0 10px rgba(0, 255, 157, 0.5)';
                        statusText.textContent = 'å·²è¿æ¥';
                    } else {
                        statusDot.style.background = 'var(--neon-red)';
                        statusDot.style.boxShadow = 'none';
                        statusText.textContent = 'æœªè¿æ¥';
                    }
                }
            }

            addVisionDebug(message) {
                const debugInfo = document.getElementById('visionDebugInfo');
                if (!debugInfo) return;

                const now = new Date().toLocaleTimeString();
                const newLine = `[${now}] ${message}\n`;
                debugInfo.textContent = newLine + debugInfo.textContent;

                // é™åˆ¶è¡Œæ•°
                const lines = debugInfo.textContent.split('\n');
                if (lines.length > 10) {
                    debugInfo.textContent = lines.slice(0, 10).join('\n');
                }
            }

            addVisionLog(type, message, isFire = false) {
                const logContainer = document.getElementById('visionLogContainer');
                if (!logContainer) return;

                const now = new Date();
                const timeStr = now.toLocaleTimeString();

                const logEntry = document.createElement('div');
                logEntry.style.padding = '8px 12px';
                logEntry.style.marginBottom = '8px';
                logEntry.style.borderRadius = '5px';
                logEntry.style.fontSize = '0.85em';
                logEntry.style.borderLeft = isFire ? '4px solid var(--neon-red)' : '4px solid var(--neon-blue)';
                logEntry.style.background = isFire ? 'rgba(255, 0, 85, 0.1)' : 'rgba(0, 243, 255, 0.1)';
                logEntry.textContent = `[${timeStr}] ${type}: ${message}`;

                logContainer.insertBefore(logEntry, logContainer.firstChild);

                // é™åˆ¶æ—¥å¿—æ•°é‡
                while (logContainer.children.length > 100) {
                    logContainer.removeChild(logContainer.lastChild);
                }
            }

            handleVisionImageFrame(blob) {
                if (!this.visionCanvas || !this.visionCtx) return;

                this.addVisionDebug(`ğŸ“· æ”¶åˆ°å›¾åƒå¸§: ${blob.size} å­—èŠ‚`);

                const img = new Image();
                img.onload = () => {
                    this.visionCanvas.width = img.width;
                    this.visionCanvas.height = img.height;
                    this.visionCtx.drawImage(img, 0, 0);
                    URL.revokeObjectURL(img.src);
                };
                img.src = URL.createObjectURL(blob);

                // æ›´æ–°FPS
                this.visionFrameCount++;
                const now = Date.now();
                const elapsed = (now - this.visionLastFrameTime) / 1000;
                if (elapsed >= 1.0) {
                    const fps = this.visionFrameCount / elapsed;
                    const fpsCounter = document.getElementById('visionFpsCounter');
                    if (fpsCounter) {
                        fpsCounter.textContent = `FPS: ${fps.toFixed(1)}`;
                    }
                    this.visionFrameCount = 0;
                    this.visionLastFrameTime = now;
                }

                // æ›´æ–°å¸§ä¿¡æ¯
                const frameInfo = document.getElementById('visionFrameInfo');
                if (frameInfo) {
                    frameInfo.textContent = `å›¾åƒå¤§å°: ${(blob.size / 1024).toFixed(1)} KB`;
                }
            }

            handleVisionTextMessage(data) {
                this.addVisionDebug(`å¤„ç†æ¶ˆæ¯ç±»å‹: ${data.type}`);

                if (data.type === 'ai_detection') {
                    const detections = data.data.detections;
                    let humans = 0;
                    let fires = 0;

                    detections.forEach(det => {
                        if (det.class_id === 0) humans++;
                        else fires++;
                    });

                    this.addVisionDebug(`ğŸ¯ æ£€æµ‹: ${humans}äºº, ${fires}ç«`);

                    // æ›´æ–°ç»Ÿè®¡
                    const humanCount = document.getElementById('visionHumanCount');
                    const fireCount = document.getElementById('visionFireCount');
                    const humanCard = document.getElementById('visionHumanCard');
                    const fireCard = document.getElementById('visionFireCard');

                    if (humanCount) humanCount.textContent = humans;
                    if (fireCount) fireCount.textContent = fires;

                    // é«˜äº®åŠ¨ç”»
                    if (humans > 0 && humanCard) {
                        humanCard.style.transform = 'scale(1.05)';
                        humanCard.style.boxShadow = '0 4px 20px rgba(0, 243, 255, 0.4)';
                        setTimeout(() => {
                            humanCard.style.transform = '';
                            humanCard.style.boxShadow = '';
                        }, 500);
                    }
                    if (fires > 0 && fireCard) {
                        fireCard.style.transform = 'scale(1.05)';
                        fireCard.style.boxShadow = '0 4px 20px rgba(255, 0, 85, 0.4)';
                        setTimeout(() => {
                            fireCard.style.transform = '';
                            fireCard.style.boxShadow = '';
                        }, 500);
                    }

                    // è®¡ç®—å»¶è¿Ÿ
                    const latency = Date.now() - data.timestamp;
                    const latencyCounter = document.getElementById('visionLatencyCounter');
                    if (latencyCounter) {
                        latencyCounter.textContent = `å»¶è¿Ÿ: ${latency}ms`;
                    }

                    // æ·»åŠ æ—¥å¿—
                    if (humans > 0) {
                        this.addVisionLog('æ£€æµ‹', `å‘ç° ${humans} ä¸ªäºº`, false);
                    }
                    if (fires > 0) {
                        this.addVisionLog('è­¦æŠ¥', `å‘ç° ${fires} å¤„ç«æºï¼`, true);
                    }
                } else if (data.type === 'system') {
                    this.addVisionDebug(`ç³»ç»Ÿæ¶ˆæ¯: ${data.data}`);
                    this.addVisionLog('ç³»ç»Ÿ', data.data);
                }
            }

            // ========== è§†è§‰æ¨¡å¼ (Vision Mode) ==========

            // åˆ‡æ¢åˆ°è§†è§‰æ¨¡å¼
            switchToVisionMode() {
                this.currentMode = 'vision';
                this.updateModeButtons('vision');

                // ä¿å­˜å½“å‰è¿æ¥é…ç½®
                // const currentServerUrl = document.getElementById('visionServerUrl');
                // const currentServerPort = document.getElementById('visionServerPort');
                // if (currentServerUrl) this.wsServer = currentServerUrl.value || this.wsServer;
                // if (currentServerPort) this.wsPort = currentServerPort.value || this.wsPort;

                const main = document.getElementById('mainContent');
                main.innerHTML = `
                <section class="vision-section">
                    <div class="vision-container">
                        <!-- è§†é¢‘æµåŒºåŸŸ -->
                        <div class="video-stream-container">
                            <div class="video-wrapper">
                                <img id="visionStream" src="images/placeholder_cam.svg" alt="å®æ—¶è§†é¢‘æµ" class="video-feed">
                                <div class="video-overlay" id="visionOverlay">
                                    <div class="status-badge disconnected" id="visionStatusBadge">æœªè¿æ¥ä¿¡å·</div>
                                    <div class="fps-counter" id="fpsCounter">FPS: 0</div>
                                </div>
                            </div>
                        </div>

                        <!-- å³ä¾§æ§åˆ¶ä¸ä¿¡æ¯ -->
                        <div class="vision-sidebar">
                            <div class="vision-panel connection-panel">
                                <h3>ğŸ”Œ è¿æ¥é…ç½®</h3>
                                <div class="config-group">
                                    <label>æœåŠ¡å™¨:</label>
                                    <input type="text" id="visionServerUrl" value="${this.wsServer}" class="tech-input">
                                </div>
                                <div class="config-group">
                                    <label>ç«¯å£:</label>
                                    <input type="number" id="visionServerPort" value="${this.wsPort}" class="tech-input">
                                </div>
                                <div class="btn-group">
                                    <button id="visionConnectBtn" class="btn-primary" onclick="modeManager.connectVision()">è¿æ¥è§†é¢‘æµ</button>
                                    <button id="visionDisconnectBtn" class="btn-secondary" onclick="modeManager.disconnectVision()" disabled>æ–­å¼€</button>
                                </div>
                            </div>

                            <!-- ğŸ” éšç§æ¨¡å¼æ§åˆ¶é¢æ¿ -->
                            <div class="vision-panel privacy-panel" style="margin-top: 15px;">
                                <h3>ğŸ” éšç§æ¨¡å¼</h3>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 0;">
                                    <span style="font-size: 13px; color: var(--text-secondary);">å¼€å¯åè§†é¢‘æ¨¡ç³Šï¼Œä»…æ˜¾ç¤ºAIæ•°æ®</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="privacyModeToggle" onchange="modeManager.togglePrivacyMode(this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div id="privacyModeStatus" style="font-size: 12px; color: var(--neon-green); text-align: center; padding: 8px; background: rgba(0, 255, 157, 0.1); border-radius: 6px; display: none;">
                                    âœ… è¾¹ç¼˜AIæ¨¡å¼æ¿€æ´» - åŸå§‹å›¾åƒå·²ä¿æŠ¤
                                </div>
                            </div>

                            <div class="vision-panel detection-panel">
                                <h3>ğŸ¯ å®æ—¶æ£€æµ‹</h3>
                                <div class="stat-grid">
                                    <div class="stat-item">
                                        <span class="stat-label">ğŸ‘¥ äººå‘˜</span>
                                        <span class="stat-value" id="detectHumanCount">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">ğŸ”¥ ç«ç„°</span>
                                        <span class="stat-value" id="detectFireCount">0</span>
                                    </div>
                                </div>
                                <div class="detection-log" id="detectionLog">
                                    <div class="log-entry dim">ç­‰å¾…æ£€æµ‹æ•°æ®...</div>
                                </div>
                            </div>
                            
                            <div class="vision-panel gesture-panel">
                                <h3>âœ‹ æ‰‹åŠ¿è¯†åˆ«</h3>
                                <div class="gesture-status" id="visionGestureStatus">
                                    <div style="font-size: 24px; margin-bottom: 8px;">Waiting...</div>
                                    <div style="font-size: 12px; color: var(--text-dim);">è¯·åœ¨æ‘„åƒå¤´å‰åšæ‰‹åŠ¿</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;

                // æ›´æ–°è¿æ¥çŠ¶æ€UI
                this.updateVisionStatus(this.isConnected);
            }

            // æ›´æ–°è§†è§‰æ¨¡å¼è¿æ¥çŠ¶æ€UI
            updateVisionStatus(connected) {
                const connectBtn = document.getElementById('visionConnectBtn');
                const disconnectBtn = document.getElementById('visionDisconnectBtn');
                const statusBadge = document.getElementById('visionStatusBadge');

                if (connectBtn && disconnectBtn) {
                    connectBtn.disabled = connected;
                    disconnectBtn.disabled = !connected;
                }

                if (statusBadge) {
                    if (connected) {
                        statusBadge.textContent = 'âš« LIVE';
                        statusBadge.className = 'status-badge connected';
                    } else {
                        statusBadge.textContent = 'æœªè¿æ¥ä¿¡å·';
                        statusBadge.className = 'status-badge disconnected';
                    }
                }
            }

            // è¿æ¥è§†è§‰æµ
            connectVision() {
                const url = document.getElementById('visionServerUrl').value || 'localhost';
                const port = document.getElementById('visionServerPort').value || '8080';

                // ä½¿ç”¨å…±äº«è¿æ¥
                this.connectSharedWebSocket(url, port);
            }

            // æ–­å¼€è§†è§‰æµ
            disconnectVision() {
                this.disconnectSharedWebSocket();
            }

            // ğŸ” éšç§æ¨¡å¼åˆ‡æ¢
            togglePrivacyMode(enabled) {
                this.privacyModeEnabled = enabled;
                const img = document.getElementById('visionStream');
                const statusEl = document.getElementById('privacyModeStatus');

                if (img) {
                    if (enabled) {
                        // åº”ç”¨å¼ºåŠ›æ¨¡ç³Š + é©¬èµ›å…‹æ•ˆæœ
                        img.style.filter = 'blur(25px) saturate(0.3) brightness(0.6)';
                        img.style.transition = 'filter 0.5s ease';
                        console.log('ğŸ” éšç§æ¨¡å¼å·²å¼€å¯ - è§†é¢‘å·²æ¨¡ç³Šï¼ŒAIæ•°æ®ç»§ç»­æ˜¾ç¤º');
                    } else {
                        // ç§»é™¤æ¨¡ç³Š
                        img.style.filter = 'none';
                        img.style.transition = 'filter 0.5s ease';
                        console.log('ğŸ‘ï¸ éšç§æ¨¡å¼å·²å…³é—­ - æ¢å¤åŸå§‹è§†é¢‘');
                    }
                }

                if (statusEl) {
                    statusEl.style.display = enabled ? 'block' : 'none';
                }
            }

            // å¤„ç†è§†è§‰å›¾åƒå¸§ (Binary Blob)
            handleVisionImageFrame(blob) {
                const img = document.getElementById('visionStream');
                if (img) {
                    // é‡Šæ”¾æ—§çš„URLå¯¹è±¡ä»¥é‡Šæ”¾å†…å­˜
                    if (this.lastObjectUrl) {
                        URL.revokeObjectURL(this.lastObjectUrl);
                    }

                    // åˆ›å»ºæ–°çš„URLå¯¹è±¡
                    this.lastObjectUrl = URL.createObjectURL(blob);
                    img.src = this.lastObjectUrl;

                    // å¦‚æœéšç§æ¨¡å¼å¼€å¯ï¼Œç¡®ä¿æ¨¡ç³Šæ•ˆæœæŒç»­
                    if (this.privacyModeEnabled) {
                        img.style.filter = 'blur(25px) saturate(0.3) brightness(0.6)';
                    }

                    // æ›´æ–°FPS
                    this.updateFPS();
                }
            }

            // è®¡ç®—å¹¶æ›´æ–°FPS
            updateFPS() {
                const now = Date.now();
                if (!this.lastFrameTime) {
                    this.lastFrameTime = now;
                    this.fps = 0;
                    return;
                }

                const delta = now - this.lastFrameTime;
                this.lastFrameTime = now;

                // ç®€å•çš„FPSè®¡ç®— (å¹³æ»‘å¤„ç†)
                const currentFps = 1000 / delta;
                this.fps = this.fps * 0.9 + currentFps * 0.1;

                const fpsEl = document.getElementById('fpsCounter');
                if (fpsEl) {
                    fpsEl.textContent = `FPS: ${this.fps.toFixed(1)}`;
                }
            }

            // å¤„ç†è§†è§‰æ–‡æœ¬æ¶ˆæ¯ (AIæ£€æµ‹ç»“æœ)
            handleVisionTextMessage(message) {
                if (message.type === 'ai_detection') {
                    const data = message.data;
                    const detections = data.detections || [];

                    // æ›´æ–°è®¡æ•°
                    let humanCount = 0;
                    let fireCount = 0;

                    detections.forEach(det => {
                        if (det.class_id === 0) humanCount++; // å‡è®¾0æ˜¯äºº
                        else fireCount++; // å…¶ä»–æ˜¯ç«
                    });

                    const humanEl = document.getElementById('detectHumanCount');
                    const fireEl = document.getElementById('detectFireCount');

                    if (humanEl) humanEl.textContent = humanCount;
                    if (fireEl) {
                        fireEl.textContent = fireCount;
                        if (fireCount > 0) {
                            fireEl.style.color = '#ff3b30';
                            fireEl.style.textShadow = '0 0 10px rgba(255, 59, 48, 0.6)';
                        } else {
                            fireEl.style.color = 'var(--text-primary)';
                            fireEl.style.textShadow = 'none';
                        }
                    }

                    // æ›´æ–°æ—¥å¿—
                    if (detections.length > 0) {
                        const logEl = document.getElementById('detectionLog');
                        if (logEl) {
                            const time = new Date().toLocaleTimeString();
                            const logContent = detections.map(d => `${d.class_name} (${(d.score * 100).toFixed(0)}%)`).join(', ');

                            const entry = document.createElement('div');
                            entry.className = 'log-entry';
                            entry.innerHTML = `<span class="log-time">[${time}]</span> ${logContent}`;

                            logEl.prepend(entry);

                            // é™åˆ¶æ—¥å¿—æ•°é‡
                            if (logEl.children.length > 100) {
                                logEl.removeChild(logEl.lastChild);
                            }
                        }
                    }
                } else if (message.type === 'system') {
                    // ç³»ç»Ÿæ¶ˆæ¯å¤„ç†...
                }
            }
        }

        // å…¨å±€å‡½æ•°
        function switchToAIMode() {
            modeManager.switchToAIMode();
        }

        function switchToSensorMode() {
            modeManager.switchToSensorMode();
        }

        function switchToControlMode() {
            modeManager.switchToControlMode();
        }

        function switchToVisionMode() {
            modeManager.switchToVisionMode();
        }

        // æ§åˆ¶æ¨¡å¼å…¨å±€å‡½æ•°

        // è®¾å¤‡å¼€å…³çŠ¶æ€
        let fanEnabled = false;
        let windowEnabled = false;
        let indicatorLightEnabled = true;  // é»˜è®¤å¼€å¯ï¼Œä¸ESP32åŒæ­¥

        // ========== é£æ‰‡æ§åˆ¶ï¼ˆç”µæœºï¼‰==========
        function toggleFan(enabled) {
            fanEnabled = enabled;
            const statusEl = document.getElementById('fanStatus');
            const controlArea = document.getElementById('fanControlArea');
            const onBtn = document.getElementById('fanOnBtn');
            const offBtn = document.getElementById('fanOffBtn');

            if (enabled) {
                statusEl.textContent = 'å¼€å¯';
                statusEl.style.color = '#30d158';
                controlArea.style.opacity = '1';
                controlArea.style.pointerEvents = 'auto';
                onBtn.style.opacity = '0.5';
                offBtn.style.opacity = '1';

                // å‘é€å½“å‰æ»‘å—çš„é€Ÿåº¦å€¼
                const speed = parseInt(document.getElementById('fanSpeed').value);
                document.getElementById('fanSpeedValue').textContent = `${speed}%`;
                document.getElementById('fanPWM').textContent = `${speed}%`;
                const command = `MOTOR_${speed}`;
                sendControlCommand(command);
                console.log(`ğŸŒ€ é£æ‰‡å·²å¼€å¯ï¼Œè½¬é€Ÿ: ${speed}%`);
            } else {
                statusEl.textContent = 'å…³é—­';
                statusEl.style.color = '#ff3b30';
                controlArea.style.opacity = '0.5';
                controlArea.style.pointerEvents = 'none';
                onBtn.style.opacity = '1';
                offBtn.style.opacity = '0.5';

                // å‘é€åœæ­¢å‘½ä»¤
                const command = 'MOTOR_0';
                sendControlCommand(command);
                document.getElementById('fanSpeedValue').textContent = '0%';
                document.getElementById('fanPWM').textContent = '0%';
                console.log('ğŸŒ€ é£æ‰‡å·²å…³é—­');
            }
        }

        function updateFanSpeed(speed) {
            if (!fanEnabled) return;  // æœªå¼€å¯æ—¶ä¸å“åº”

            const speedValue = parseInt(speed);
            document.getElementById('fanSpeedValue').textContent = `${speedValue}%`;
            document.getElementById('fanPWM').textContent = `${speedValue}%`;

            // å‘é€å‘½ä»¤åˆ°ESP32
            const command = `MOTOR_${speedValue}`;
            sendControlCommand(command);
        }

        function setFanSpeed(speed) {
            if (!fanEnabled) return;  // æœªå¼€å¯æ—¶ä¸å“åº”
            document.getElementById('fanSpeed').value = speed;
            updateFanSpeed(speed);
        }

        // ========== çª—æˆ·æ§åˆ¶ï¼ˆèˆµæœºï¼‰==========
        function toggleWindow(enabled) {
            windowEnabled = enabled;
            const statusEl = document.getElementById('windowStatus');
            const controlArea = document.getElementById('windowControlArea');
            const onBtn = document.getElementById('windowOnBtn');
            const offBtn = document.getElementById('windowOffBtn');

            if (enabled) {
                statusEl.textContent = 'å¼€å¯';
                statusEl.style.color = '#30d158';
                controlArea.style.opacity = '1';
                controlArea.style.pointerEvents = 'auto';
                onBtn.style.opacity = '0.5';
                offBtn.style.opacity = '1';

                // å‘é€å½“å‰æ»‘å—çš„è§’åº¦å€¼
                const angle = parseInt(document.getElementById('windowAngle').value);
                document.getElementById('windowAngleValue').textContent = `${angle}Â°`;
                document.getElementById('servoPWM').textContent = `${angle}Â°`;
                const command = `SERVO_${angle}`;
                sendControlCommand(command);
                console.log(`ğŸªŸ çª—æˆ·å·²å¼€å¯ï¼Œè§’åº¦: ${angle}Â°`);
            } else {
                statusEl.textContent = 'å…³é—­';
                statusEl.style.color = '#ff3b30';
                controlArea.style.opacity = '0.5';
                controlArea.style.pointerEvents = 'none';
                onBtn.style.opacity = '1';
                offBtn.style.opacity = '0.5';

                // å‘é€0åº¦å‘½ä»¤ï¼ˆå…³é—­çª—æˆ·ï¼‰
                const command = 'SERVO_0';
                sendControlCommand(command);
                document.getElementById('windowAngleValue').textContent = '0Â°';
                document.getElementById('servoPWM').textContent = '0Â°';
                console.log('ğŸªŸ çª—æˆ·å·²å…³é—­');
            }
        }

        function updateWindowAngle(angle) {
            if (!windowEnabled) return;  // æœªå¼€å¯æ—¶ä¸å“åº”

            const angleValue = parseInt(angle);
            document.getElementById('windowAngleValue').textContent = `${angleValue}Â°`;
            document.getElementById('servoPWM').textContent = `${angleValue}Â°`;

            // å‘é€å‘½ä»¤åˆ°ESP32
            const command = `SERVO_${angleValue}`;
            sendControlCommand(command);
        }

        function setWindowAngle(angle) {
            if (!windowEnabled) return;  // æœªå¼€å¯æ—¶ä¸å“åº”
            document.getElementById('windowAngle').value = angle;
            updateWindowAngle(angle);
        }

        // ========== æŒ‡ç¤ºç¯æ§åˆ¶ ==========
        let currentIndicatorColor = 'green';  // å½“å‰æŒ‡ç¤ºç¯é¢œè‰²

        function toggleIndicatorLight(enabled) {
            indicatorLightEnabled = enabled;

            // æ›´æ–°UI
            const statusEl = document.getElementById('ledPowerStatus');
            const colorEl = document.getElementById('indicatorLightColor');
            const onBtn = document.getElementById('ledOnBtn');
            const offBtn = document.getElementById('ledOffBtn');

            if (enabled) {
                statusEl.textContent = 'å¼€å¯';
                statusEl.style.color = '#30d158';
                onBtn.style.opacity = '0.5';
                offBtn.style.opacity = '1';
                // æ¢å¤ä¹‹å‰çš„é¢œè‰²
                updateIndicatorLightUI(currentIndicatorColor);
                const command = 'LED_ON';
                sendControlCommand(command);
                console.log('ğŸ’¡ æŒ‡ç¤ºç¯å·²å¼€å¯');
            } else {
                statusEl.textContent = 'å…³é—­';
                statusEl.style.color = '#ff3b30';
                onBtn.style.opacity = '1';
                offBtn.style.opacity = '0.5';
                // å…³é—­æ—¶æ˜¾ç¤ºç°è‰²
                colorEl.style.background = '#8e8e93';
                colorEl.style.boxShadow = '0 0 10px rgba(142, 142, 147, 0.3)';
                const command = 'LED_OFF';
                sendControlCommand(command);
                console.log('ğŸ’¡ æŒ‡ç¤ºç¯å·²å…³é—­');
            }
        }




        function updateIndicatorLightUI(color) {
            currentIndicatorColor = color;
            if (!indicatorLightEnabled) return;

            const colorEl = document.getElementById('indicatorLightColor');
            const statusEl = document.getElementById('indicatorLightStatus');

            if (color === 'green') {
                colorEl.style.background = '#34c759';
                colorEl.style.boxShadow = '0 0 20px rgba(52, 199, 89, 0.6)';
                statusEl.textContent = 'çŠ¶æ€ï¼šæ­£å¸¸';
                statusEl.style.color = '#34c759';
            } else if (color === 'red') {
                colorEl.style.background = '#ff3b30';
                colorEl.style.boxShadow = '0 0 20px rgba(255, 59, 48, 0.6)';
                statusEl.textContent = 'çŠ¶æ€ï¼šè­¦æˆ’';
                statusEl.style.color = '#ff3b30';
            }
        }

        // æ ¹æ®ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°æŒ‡ç¤ºç¯ï¼ˆæ¸©åº¦>30Â°C æˆ– çƒŸé›¾é«˜ â†’ çº¢ç¯ï¼‰
        function updateIndicatorLightFromSensorData(data) {
            if (!indicatorLightEnabled) return;

            const isAlert = (data.temperature > 30) || (data.smoke_detected === true);
            const newColor = isAlert ? 'red' : 'green';

            // åªæœ‰é¢œè‰²å˜åŒ–æ—¶æ‰æ›´æ–°UIå’Œå‘é€å‘½ä»¤
            if (newColor !== currentIndicatorColor) {
                currentIndicatorColor = newColor;
                updateIndicatorLightUI(newColor);

                // å‘é€é¢œè‰²å‘½ä»¤åˆ°ESP32
                const command = newColor === 'red' ? 'LED_RED' : 'LED_GREEN';
                sendControlCommand(command);
            }
        }

        // é€šç”¨æ§åˆ¶å‘½ä»¤å‘é€å‡½æ•°
        function sendControlCommand(command) {
            const timestamp = new Date().toLocaleTimeString();

            // æ·»åŠ æ—¥å¿—åˆ°æ˜¾ç¤ºåŒºåŸŸ
            const logEl = document.getElementById('commandLog');
            if (logEl) {
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '4px';

                if (modeManager.isConnected) {
                    logEntry.innerHTML = `<span style="color: #30d158;">âœ“</span> [${timestamp}] ${command}`;
                    modeManager.sendMessage(command);
                    console.log('âœ“ å‘é€å‘½ä»¤:', command);
                } else {
                    logEntry.innerHTML = `<span style="color: #ff3b30;">âœ—</span> [${timestamp}] ${command} <span style="color: #8e8e93;">(æœªè¿æ¥)</span>`;
                    console.log('âœ— æœªè¿æ¥ï¼Œæ— æ³•å‘é€å‘½ä»¤:', command);
                }

                // æ¸…ç©º"ç­‰å¾…å‘é€å‘½ä»¤..."æç¤º
                if (logEl.querySelector('div[style*="color: #8e8e93"]')) {
                    logEl.innerHTML = '';
                }

                logEl.appendChild(logEntry);
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        // æ¸…ç©ºå‘½ä»¤æ—¥å¿—
        function clearCommandLog() {
            const logEl = document.getElementById('commandLog');
            if (logEl) {
                logEl.innerHTML = '<div style="color: #8e8e93;">ç­‰å¾…å‘é€å‘½ä»¤...</div>';
            }
        }

        // åˆå§‹åŒ–
        const modeManager = new ModeManager();
        document.addEventListener('DOMContentLoaded', () => {
            modeManager.init();

            // åˆå§‹åŒ–æ‰‹åŠ¿/è¯­éŸ³äº¤äº’ç®¡ç†å™¨
            if (window.gestureVoiceManager) {
                window.gestureVoiceManager.init({
                    onDeviceControl: (actionData) => {
                        console.log('ğŸ® æ‰‹åŠ¿/è¯­éŸ³æ§åˆ¶å›è°ƒ:', actionData);
                        // å¯ä»¥åœ¨è¿™é‡Œè§¦å‘å®é™…çš„è®¾å¤‡æ§åˆ¶
                        if (modeManager.sharedWs && modeManager.isConnected) {
                            // å‘é€åˆ°ESP32
                            modeManager.sendMessage(actionData);
                        }
                    }
                });
                // ä¿å­˜WebSocketè¿æ¥ä¾›GestureVoiceManagerä½¿ç”¨
                window.wsConnection = modeManager.sharedWs;
            }
        });
    </script>
</body>

</html>