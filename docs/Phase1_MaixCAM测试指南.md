# Phase 1: MaixCAM端测试指南

**目标**: 验证MaixCAM能够正常检测并推流视频

---

## ✅ 已完成的工作

1. **创建备份文件**: `maixcam/main.py.backup`（原始文件已保存）
2. **编写新代码**: `maixcam/main.py`（新功能版本）

### 新增功能
- ✅ MJPEG视频流推送（HTTP端口8000）
- ✅ WebSocket连接到Web Server（端口8080）
- ✅ JSON格式检测结果发送（10Hz）
- ✅ 本地屏幕显示（带彩色检测框）
- ✅ 自动重连机制
- ✅ 详细日志输出

---

## 📝 测试前准备

### 步骤1: 查看你的电脑IP地址

**Windows系统：**
1. 按 `Win + R` 键
2. 输入 `cmd`，回车
3. 输入 `ipconfig`，回车
4. 找到"无线局域网适配器 WLAN"下的"IPv4地址"
5. 记下这个IP地址（例如：192.168.31.100）

**示例输出：**
```
无线局域网适配器 WLAN:
   IPv4 地址 . . . . . . . . : 192.168.31.100
   子网掩码  . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . : 192.168.31.1
```

### 步骤2: 修改配置文件

打开 `maixcam/main.py`，修改第20行：
```python
WEB_SERVER_IP = "192.168.31.100"  # 改成你刚才记下的IP地址
```

**⚠️ 重要提示：**
- 确保MaixCAM和电脑连接的是**同一个WiFi**
- 如果不确定，在MaixCAM上查看IP地址（应该是192.168.31.x段）

---

## 🚀 开始测试

### 测试步骤1: 上传文件到MaixCAM

**方法A：使用MaixHub IDE**
1. 打开MaixHub IDE
2. 连接MaixCAM设备
3. 将修改后的 `main.py` 上传到MaixCAM的工作目录

**方法B：使用SCP命令（如果你熟悉命令行）**
```bash
scp maixcam/main.py root@192.168.31.43:/root/
```

### 测试步骤2: 在MaixCAM上运行程序

**在MaixCAM的终端或SSH中执行：**
```bash
cd /root
python3 main.py
```

### 测试步骤3: 观察MaixCAM输出

**正常输出示例：**
```
🤖 初始化YOLOv5模型...
✅ 模型加载成功: model_243027.mud
   - 检测类别: ['human', 'fire']
   - 输入分辨率: 320x224
📷 初始化摄像头和显示屏...
✅ 摄像头和显示屏初始化完成
🎥 启动MJPEG服务器: http://192.168.31.43:8000
✅ MJPEG服务器已启动
   - 访问地址: http://192.168.31.43:8000
🔗 连接到Web Server: 192.168.31.100:8080
❌ 连接超时，请检查Web Server是否启动    <-- 这是正常的，因为我们还没启动Web Server

==================================================
🎥 系统启动，开始检测...
==================================================
📊 检测参数:
   - 置信度阈值: 0.5
   - IOU阈值: 0.45
   - 发送频率: 10.0 Hz
==================================================

📊 已处理100帧 | 当前检测: 0人, 0火
📊 已处理200帧 | 当前检测: 1人, 0火
```

---

## ✅ 验收检查清单

### 检查项1: MJPEG视频流测试

**目标**: 验证视频流是否正常推送

**测试方法：**
1. 在你的电脑浏览器中打开：
   ```
   http://192.168.31.43:8000
   ```

2. **预期结果**：
   - ✅ 能看到MaixCAM的实时视频画面
   - ✅ 视频流畅，无明显卡顿
   - ✅ 帧率大约在10-20 FPS
   - ✅ 如果有人或火焰，能看到彩色检测框（人类蓝色，火焰红色）
   - ✅ 检测框上有标签和置信度

3. **如果看不到画面**：
   - 检查MaixCAM终端是否显示"✅ MJPEG服务器已启动"
   - 检查IP地址是否正确（192.168.31.43）
   - 尝试刷新浏览器（Ctrl+F5）
   - 检查防火墙是否阻止8000端口

---

### 检查项2: 本地屏幕显示测试

**目标**: 验证MaixCAM本地屏幕是否正常显示

**测试方法：**
1. 查看MaixCAM的物理屏幕

2. **预期结果**：
   - ✅ 屏幕显示实时摄像头画面
   - ✅ 有检测对象时显示彩色检测框
   - ✅ 检测框上有类别名称和置信度

---

### 检查项3: WebSocket连接测试

**目标**: 验证MaixCAM能否连接到Web Server（当前会失败，这是正常的）

**测试方法：**
1. 观察MaixCAM终端输出

2. **当前预期结果**（Web Server还没启动）：
   - ⚠️ 显示"❌ 连接超时，请检查Web Server是否启动"
   - ⚠️ 这是**正常的**！因为我们还没有启动Web Server

3. **说明**：
   - Phase 2 会启动Web Server
   - 到时候这个错误会消失

---

### 检查项4: 检测功能测试

**目标**: 验证YOLOv5检测是否正常工作

**测试方法：**
1. 在摄像头前放置测试对象：
   - 人类：站在摄像头前或放置人物照片
   - 火焰：打火机火焰或火焰图片

2. **预期结果**：
   - ✅ 检测到人类时：
     - 蓝色检测框
     - 标签显示"human: 0.XX"
     - 终端输出"X人, 0火"
   - ✅ 检测到火焰时：
     - 红色检测框
     - 标签显示"fire: 0.XX"
     - 终端输出"0人, X火"

3. **如果没有检测到**：
   - 检查光线是否充足
   - 尝试调整距离和角度
   - 检查置信度阈值（默认0.5）

---

### 检查项5: 性能测试

**目标**: 验证系统性能是否达标

**测试方法：**
1. 观察终端输出的处理帧数
2. 观察浏览器中视频流的流畅度

**预期结果：**
- ✅ 帧率：10-20 FPS
- ✅ 延迟：< 500ms
- ✅ CPU占用：< 80%

**性能参考：**
| 分辨率 | 预期FPS | 说明 |
|--------|---------|------|
| 224x224 | 15-20 | 推荐 |
| 320x224 | 10-15 | 默认 |
| 416x416 | 5-8 | 较慢 |

---

## ❌ 常见问题排查

### 问题1: MJPEG服务器启动失败

**现象：**
```
⚠️  警告: MjpegServer模块不可用
```

**原因：** MaixPy版本可能不支持MjpegServer

**解决方案：**
1. 暂时跳过MJPEG推流测试
2. 等Phase 2时使用Web Server代理（不影响整体功能）
3. 或更新MaixPy到最新版本

---

### 问题2: 无法连接到Web Server

**现象：**
```
❌ 连接超时，请检查Web Server是否启动
```

**原因：** Web Server还没启动（Phase 2才会启动）

**解决方案：** 这是**正常的**，暂时忽略此错误

---

### 问题3: 检测框不显示

**现象：** 视频流正常，但没有检测框

**可能原因：**
1. 没有检测到对象（置信度低于0.5）
2. 摄像头前没有人或火焰

**解决方案：**
1. 确保测试对象在摄像头视野内
2. 尝试降低置信度阈值（修改第159行 `conf_th=0.3`）
3. 检查光线条件

---

### 问题4: 视频流卡顿

**现象：** 浏览器中视频流不流畅

**可能原因：**
1. 网络延迟高
2. MaixCAM性能不足
3. WiFi信号弱

**解决方案：**
1. 移近WiFi路由器
2. 关闭其他占用带宽的程序
3. 降低视频分辨率或帧率

---

## 📊 测试结果记录

请填写以下测试结果：

- [ ] **MJPEG视频流**: 能正常访问 http://192.168.31.43:8000
- [ ] **本地屏幕显示**: MaixCAM屏幕正常显示
- [ ] **检测功能**: 能检测到人类和火焰
- [ ] **检测框显示**: 检测框和标签显示正确
- [ ] **性能**: 帧率达到10 FPS以上
- [ ] **WebSocket**: 显示连接超时（正常，Phase 2会解决）

---

## 🎯 Phase 1 完成标准

**必须达成（3项）：**
1. ✅ MJPEG视频流能访问（或模块不可用但程序正常运行）
2. ✅ 本地屏幕显示正常
3. ✅ 能检测到测试对象（人或火）

**可选达成（2项）：**
1. ⭐ WebSocket连接成功（需要Phase 2完成）
2. ⭐ 帧率达到15 FPS以上

---

## 🔄 如何恢复备份

**如果新代码有问题，可以恢复原始代码：**

```bash
# 方法1：直接覆盖
cp maixcam/main.py.backup maixcam/main.py

# 方法2：重命名
mv maixcam/main.py maixcam/main.py.new
mv maixcam/main.py.backup maixcam/main.py
```

---

## ✅ 测试完成后

**如果所有必须项都通过：**
1. 保持MaixCAM程序运行
2. 告诉我"Phase 1测试通过"
3. 我会开始Phase 2（修改Web Server）

**如果有问题：**
1. 记录错误信息（截图或复制终端输出）
2. 告诉我具体的问题
3. 我会帮你排查

---

**祝测试顺利！有任何问题随时问我。** 🚀
